<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly/Monthly Toggle Fix Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-section { background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 8px; border: 1px solid #dee2e6; }
        .toggle-container { background: #ffffff; border: 1px solid #d1d5db; border-radius: 8px; padding: 4px; display: inline-flex; gap: 2px; }
        .toggle-btn { padding: 8px 16px; font-size: 14px; border-radius: 6px; border: none; cursor: pointer; background: transparent; color: #6b7280; transition: all 0.2s ease; }
        .toggle-btn:hover { background: #f9fafb; color: #111827; }
        .toggle-btn.active { background: #1877f2; color: white; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
        .api-result { background: #e8f5e8; border: 1px solid #4caf50; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 12px; }
        .error-result { background: #ffebee; border: 1px solid #f44336; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 12px; }
        .dashboard-card { background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin: 8px; min-width: 180px; text-align: center; display: inline-block; }
        .dashboard-title { font-size: 12px; color: #6b7280; margin-bottom: 8px; }
        .dashboard-value { font-size: 18px; font-weight: bold; color: #111827; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .test-btn { background: #28a745; }
        .test-btn:hover { background: #1e7e34; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”§ Weekly/Monthly Toggle Fix Test</h1>
        <p><strong>Issue:</strong> Show changes from weekly/monthly toggles not working</p>
        <p><strong>Fix:</strong> Updated frontend to handle API response format with success wrapper</p>
        
        <div class="test-section">
            <h2>ðŸŽ¯ Toggle Controls</h2>
            <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
                <span style="font-size: 14px; color: #4b5563;">Show changes from:</span>
                <div class="toggle-container">
                    <button id="weeklyToggle" class="toggle-btn active">Last Week</button>
                    <button id="monthlyToggle" class="toggle-btn">Last Month</button>
                    <button id="noCompareToggle" class="toggle-btn">No Comparison</button>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <button id="testWeeklyBtn" class="test-btn">Test Weekly API</button>
                <button id="testMonthlyBtn" class="test-btn">Test Monthly API</button>
                <button id="testToggleBtn" class="test-btn">Test Toggle Function</button>
            </div>
        </div>
        
        <div class="test-section">
            <h2>ðŸ“Š API Test Results</h2>
            <div id="apiResults">
                <p>Click the test buttons above to see API responses...</p>
            </div>
        </div>
        
        <div class="test-section">
            <h2>ðŸŽ¯ Expected vs Current Comparison</h2>
            <div id="comparisonResults">
                <div class="dashboard-card">
                    <div class="dashboard-title">Total Opportunities</div>
                    <div id="totalOpportunities" class="dashboard-value">Loading...</div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-title">OP100 Count</div>
                    <div id="op100Count" class="dashboard-value">Loading...</div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-title">OP90 Count</div>
                    <div id="op90Count" class="dashboard-value">Loading...</div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-title">Total Submitted</div>
                    <div id="totalSubmitted" class="dashboard-value">Loading...</div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>ðŸ“‹ Test Instructions</h2>
            <ol>
                <li><strong>Test API Endpoints:</strong> Click "Test Weekly API" and "Test Monthly API" to verify the endpoints return data</li>
                <li><strong>Check Response Format:</strong> Verify the API returns <code>{success: true, data: {...}}</code> format</li>
                <li><strong>Test Toggle Function:</strong> Click "Test Toggle Function" to simulate the toggle functionality</li>
                <li><strong>Verify Calculations:</strong> Check that the deltas are calculated correctly</li>
                <li><strong>Expected Results:</strong>
                    <ul>
                        <li><strong>Weekly:</strong> Current (437) vs Baseline (428) = +9 opportunities</li>
                        <li><strong>Monthly:</strong> Current (437) vs Baseline (344) = +93 opportunities</li>
                    </ul>
                </li>
            </ol>
        </div>
    </div>

    <script>
        let currentMode = 'weekly';
        
        function log(message, isError = false) {
            const results = document.getElementById('apiResults');
            const div = document.createElement('div');
            div.className = isError ? 'error-result' : 'api-result';
            div.textContent = new Date().toLocaleTimeString() + ': ' + message;
            results.appendChild(div);
            console.log(message);
        }
        
        async function fetchWeeklyData() {
            try {
                const response = await fetch(getApiUrl(window.APP_CONFIG.ENDPOINTS.SNAPSHOTS + '/weekly'), {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                displayData('weekly', data);
            } catch (error) {
                console.error('Error fetching weekly data:', error);
                document.getElementById('weeklyData').innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }
        
        async function fetchMonthlyData() {
            try {
                const response = await fetch(getApiUrl(window.APP_CONFIG.ENDPOINTS.SNAPSHOTS + '/monthly'), {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                displayData('monthly', data);
            } catch (error) {
                console.error('Error fetching monthly data:', error);
                document.getElementById('monthlyData').innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }
        
        async function testToggleFunction() {
            log('ðŸ§ª Testing toggle function with simulated data...');
            
            // Simulate current data (from your recent updates)
            const currentData = {
                totalOpportunities: 437,
                op100Count: 32,
                op90Count: 27,
                totalSubmitted: 277
            };
            
            // Test weekly comparison
            try {
                const weeklyResponse = await fetch('/api/snapshots/weekly');
                const weeklyResult = await weeklyResponse.json();
                
                if (weeklyResult.success && weeklyResult.data) {
                    const weeklyBaseline = weeklyResult.data;
                    const weeklyDelta = currentData.totalOpportunities - weeklyBaseline.total_opportunities;
                    const submittedDelta = currentData.totalSubmitted - weeklyBaseline.submitted_count;
                    
                    log(`ðŸ“ˆ Weekly Comparison: ${currentData.totalOpportunities} (${weeklyDelta >= 0 ? '+' : ''}${weeklyDelta}) opportunities`);
                    log(`ðŸ“ˆ Weekly Submitted: ${currentData.totalSubmitted} (${submittedDelta >= 0 ? '+' : ''}${submittedDelta}) submitted`);
                    
                    // Update display
                    document.getElementById('totalOpportunities').textContent = `${currentData.totalOpportunities} (${weeklyDelta >= 0 ? '+' : ''}${weeklyDelta})`;
                    document.getElementById('totalSubmitted').textContent = `${currentData.totalSubmitted} (${submittedDelta >= 0 ? '+' : ''}${submittedDelta})`;
                }
            } catch (error) {
                log(`âŒ Toggle test error: ${error.message}`, true);
            }
            
            // Test monthly comparison
            try {
                const monthlyResponse = await fetch('/api/snapshots/monthly');
                const monthlyResult = await monthlyResponse.json();
                
                if (monthlyResult.success && monthlyResult.data) {
                    const monthlyBaseline = monthlyResult.data;
                    const monthlyDelta = currentData.totalOpportunities - monthlyBaseline.total_opportunities;
                    const monthlySubmittedDelta = currentData.totalSubmitted - monthlyBaseline.submitted_count;
                    
                    log(`ðŸ“ˆ Monthly Comparison: ${currentData.totalOpportunities} (${monthlyDelta >= 0 ? '+' : ''}${monthlyDelta}) opportunities`);
                    log(`ðŸ“ˆ Monthly Submitted: ${currentData.totalSubmitted} (${monthlySubmittedDelta >= 0 ? '+' : ''}${monthlySubmittedDelta}) submitted`);
                }
            } catch (error) {
                log(`âŒ Monthly toggle test error: ${error.message}`, true);
            }
        }
        
        function setToggleMode(mode) {
            currentMode = mode;
            
            // Update button states
            document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
            
            const activeButtonId = mode === 'weekly' ? 'weeklyToggle' :
                                 mode === 'monthly' ? 'monthlyToggle' : 'noCompareToggle';
            document.getElementById(activeButtonId).classList.add('active');
            
            log(`ðŸ”„ Switched to ${mode} mode`);
        }
        
        // Initialize
        document.getElementById('testWeeklyBtn').addEventListener('click', fetchWeeklyData);
        document.getElementById('testMonthlyBtn').addEventListener('click', fetchMonthlyData);
        document.getElementById('testToggleBtn').addEventListener('click', testToggleFunction);
        
        document.getElementById('weeklyToggle').addEventListener('click', () => setToggleMode('weekly'));
        document.getElementById('monthlyToggle').addEventListener('click', () => setToggleMode('monthly'));
        document.getElementById('noCompareToggle').addEventListener('click', () => setToggleMode('none'));
        
        // Auto-run tests on load
        window.onload = function() {
            log('ðŸš€ Weekly/Monthly Toggle Fix Test initialized');
            log('ðŸ“Œ The fix handles API response format: {success: true, data: {...}}');
            setTimeout(() => {
                fetchWeeklyData();
                setTimeout(() => {
                    fetchMonthlyData();
                    setTimeout(() => {
                        testToggleFunction();
                    }, 1000);
                }, 1000);
            }, 500);
        };
    </script>
</body>
</html> 