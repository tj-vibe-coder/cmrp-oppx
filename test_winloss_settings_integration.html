<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Win-Loss Settings Integration Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { color: blue; }
        .warning { color: orange; }
        button { margin: 5px; padding: 8px 12px; cursor: pointer; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; font-family: monospace; max-height: 200px; overflow-y: auto; }
        select { margin: 5px; padding: 5px; }
        .quarter-btn { margin: 2px; padding: 5px 10px; border: 1px solid #ccc; cursor: pointer; }
        .quarter-btn.active { background: #007cba; color: white; }
    </style>
</head>
<body>
    <h1>Win-Loss Dashboard Settings Integration Test</h1>
    
    <div class="test-section">
        <h3>1. Test Settings Save/Load Cycle</h3>
        <div>
            <button onclick="saveTestSettings()">Save Test Settings</button>
            <button onclick="loadAndShowSettings()">Load Settings</button>
            <button onclick="clearAllSettings()">Clear All</button>
        </div>
        <div id="cycle-results"></div>
    </div>

    <div class="test-section">
        <h3>2. Simulate Dashboard Filter Dropdowns</h3>
        <div>
            <label>Solution:</label>
            <select id="solutionFilter">
                <option value="all">All Solutions</option>
                <option value="Data Analytics">Data Analytics</option>
                <option value="Cloud Solutions">Cloud Solutions</option>
                <option value="AI/ML">AI/ML</option>
            </select>
            
            <label>Account Manager:</label>
            <select id="accountMgrFilter">
                <option value="all">All</option>
                <option value="John Doe">John Doe</option>
                <option value="Jane Smith">Jane Smith</option>
                <option value="Bob Wilson">Bob Wilson</option>
            </select>
            
            <label>Client:</label>
            <select id="clientFilter">
                <option value="all">All</option>
                <option value="Client A">Client A</option>
                <option value="Client B">Client B</option>
                <option value="Client C">Client C</option>
            </select>
        </div>
        <div>
            <button onclick="simulateDropdownChanges()">Simulate Changes & Save</button>
            <button onclick="simulatePageReload()">Simulate Page Reload</button>
        </div>
        <div id="dropdown-results"></div>
    </div>

    <div class="test-section">
        <h3>3. Simulate Quarter Filter Buttons</h3>
        <div>
            <button class="quarter-btn" data-quarter="1" onclick="toggleQuarter(1)">Q1</button>
            <button class="quarter-btn" data-quarter="2" onclick="toggleQuarter(2)">Q2</button>
            <button class="quarter-btn" data-quarter="3" onclick="toggleQuarter(3)">Q3</button>
            <button class="quarter-btn" data-quarter="4" onclick="toggleQuarter(4)">Q4</button>
        </div>
        <div>
            <button onclick="saveQuarterState()">Save Quarter State</button>
            <button onclick="loadQuarterState()">Load Quarter State</button>
        </div>
        <div id="quarter-results"></div>
    </div>

    <div class="test-section">
        <h3>4. Simulate Table Filter & Sort</h3>
        <div>
            <button id="filterOP100Btn" onclick="setTableFilter('OP100')">OP100</button>
            <button id="filterLOSTBtn" onclick="setTableFilter('LOST')">LOST</button>
        </div>
        <div>
            <button onclick="setTableSort('project_name', 1)">Sort by Project (ASC)</button>
            <button onclick="setTableSort('final_amt', -1)">Sort by Amount (DESC)</button>
        </div>
        <div id="table-results"></div>
    </div>

    <div class="test-section">
        <h3>5. Test Theme Persistence</h3>
        <div>
            <button onclick="setTheme('dark')">Set Dark Theme</button>
            <button onclick="setTheme('light')">Set Light Theme</button>
            <button onclick="checkTheme()">Check Current Theme</button>
        </div>
        <div id="theme-results"></div>
    </div>

    <div class="test-section">
        <h3>Console Log</h3>
        <div id="console-log" class="log"></div>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <script>
        // Copy the exact settings functions from win-loss_dashboard.js
        const SETTINGS_KEY = 'winLossDashboardSettings';

        // Global state variables
        let currentSolutionFilter = 'all';
        let currentAccountMgrFilter = 'all';
        let currentClientFilter = 'all';
        let activeQuarters = { '1': true, '2': true, '3': false, '4': false };
        let currentTableStatusFilter = 'OP100';
        let currentSort = { col: null, dir: 1 };

        // Logging function
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('console-log');
            const entry = document.createElement('div');
            entry.innerHTML = `<span style="color: gray">[${timestamp}]</span> <span class="${type}">${message}</span>`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('console-log').innerHTML = '';
        }

        // Settings functions from win-loss_dashboard.js
        function saveSettings() {
            const settings = {
                currentSolutionFilter,
                currentAccountMgrFilter,
                currentClientFilter,
                activeQuarters,
                currentTableStatusFilter,
                currentSort,
                theme: document.documentElement.classList.contains('dark') ? 'dark' : 'light'
            };
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
            log(`[SETTINGS] Saved: ${JSON.stringify(settings)}`, 'success');
            return settings;
        }

        function loadSettings() {
            try {
                const saved = localStorage.getItem(SETTINGS_KEY);
                if (saved) {
                    const settings = JSON.parse(saved);
                    log(`[SETTINGS] Loaded: ${JSON.stringify(settings)}`, 'success');
                    
                    // Restore filter states
                    if (settings.currentSolutionFilter !== undefined) {
                        currentSolutionFilter = settings.currentSolutionFilter;
                    }
                    if (settings.currentAccountMgrFilter !== undefined) {
                        currentAccountMgrFilter = settings.currentAccountMgrFilter;
                    }
                    if (settings.currentClientFilter !== undefined) {
                        currentClientFilter = settings.currentClientFilter;
                    }
                    if (settings.activeQuarters !== undefined) {
                        activeQuarters = settings.activeQuarters;
                    }
                    if (settings.currentTableStatusFilter !== undefined) {
                        currentTableStatusFilter = settings.currentTableStatusFilter;
                    }
                    if (settings.currentSort !== undefined) {
                        currentSort = settings.currentSort;
                    }
                    
                    return settings;
                }
            } catch (error) {
                log(`[SETTINGS] Error loading: ${error.message}`, 'error');
                return null;
            }
            return null;
        }

        // Test functions
        function saveTestSettings() {
            currentSolutionFilter = 'Data Analytics';
            currentAccountMgrFilter = 'John Doe';
            currentClientFilter = 'Client B';
            activeQuarters = { '1': true, '2': false, '3': true, '4': false };
            currentTableStatusFilter = 'LOST';
            currentSort = { col: 'final_amt', dir: -1 };
            
            const saved = saveSettings();
            document.getElementById('cycle-results').innerHTML = `
                <div class="success">‚úÖ Test settings saved</div>
                <pre>${JSON.stringify(saved, null, 2)}</pre>
            `;
        }

        function loadAndShowSettings() {
            // Reset to defaults first
            currentSolutionFilter = 'all';
            currentAccountMgrFilter = 'all';
            currentClientFilter = 'all';
            activeQuarters = { '1': false, '2': false, '3': false, '4': false };
            currentTableStatusFilter = 'OP100';
            currentSort = { col: null, dir: 1 };
            
            const loaded = loadSettings();
            
            if (loaded) {
                document.getElementById('cycle-results').innerHTML = `
                    <div class="success">‚úÖ Settings loaded successfully</div>
                    <pre>Loaded: ${JSON.stringify(loaded, null, 2)}</pre>
                    <pre>Current State:
Solution: ${currentSolutionFilter}
Account Mgr: ${currentAccountMgrFilter}
Client: ${currentClientFilter}
Quarters: ${JSON.stringify(activeQuarters)}
Table Filter: ${currentTableStatusFilter}
Sort: ${JSON.stringify(currentSort)}</pre>
                `;
            } else {
                document.getElementById('cycle-results').innerHTML = `
                    <div class="info">‚ÑπÔ∏è No saved settings found</div>
                `;
            }
        }

        function clearAllSettings() {
            localStorage.removeItem(SETTINGS_KEY);
            log('[SETTINGS] Cleared all settings', 'info');
            
            // Reset to defaults
            currentSolutionFilter = 'all';
            currentAccountMgrFilter = 'all';
            currentClientFilter = 'all';
            activeQuarters = { '1': true, '2': true, '3': false, '4': false };
            currentTableStatusFilter = 'OP100';
            currentSort = { col: null, dir: 1 };
            
            updateDropdownsToCurrentState();
            updateQuarterButtons();
            
            document.getElementById('cycle-results').innerHTML = `
                <div class="info">üóëÔ∏è All settings cleared and reset to defaults</div>
            `;
        }

        function simulateDropdownChanges() {
            const solutionDropdown = document.getElementById('solutionFilter');
            const mgrDropdown = document.getElementById('accountMgrFilter');
            const clientDropdown = document.getElementById('clientFilter');
            
            // Simulate user changing dropdowns
            currentSolutionFilter = solutionDropdown.value;
            currentAccountMgrFilter = mgrDropdown.value;
            currentClientFilter = clientDropdown.value;
            
            const saved = saveSettings();
            
            document.getElementById('dropdown-results').innerHTML = `
                <div class="success">‚úÖ Dropdown changes saved</div>
                <div>Solution: ${currentSolutionFilter}</div>
                <div>Account Mgr: ${currentAccountMgrFilter}</div>
                <div>Client: ${currentClientFilter}</div>
            `;
            
            log(`[DROPDOWN] Values changed and saved: Sol=${currentSolutionFilter}, Mgr=${currentAccountMgrFilter}, Client=${currentClientFilter}`, 'success');
        }

        function simulatePageReload() {
            log('[SIMULATION] Simulating page reload...', 'info');
            
            // Reset UI to defaults (simulating fresh page load)
            document.getElementById('solutionFilter').value = 'all';
            document.getElementById('accountMgrFilter').value = 'all';
            document.getElementById('clientFilter').value = 'all';
            
            // Reset state variables
            currentSolutionFilter = 'all';
            currentAccountMgrFilter = 'all';
            currentClientFilter = 'all';
            
            // Now load settings (simulating page initialization)
            const loaded = loadSettings();
            
            if (loaded) {
                // Restore dropdown values
                document.getElementById('solutionFilter').value = currentSolutionFilter;
                document.getElementById('accountMgrFilter').value = currentAccountMgrFilter;
                document.getElementById('clientFilter').value = currentClientFilter;
                
                document.getElementById('dropdown-results').innerHTML = `
                    <div class="success">‚úÖ Page reload simulation complete - settings restored</div>
                    <div>Solution: ${currentSolutionFilter} (dropdown: ${document.getElementById('solutionFilter').value})</div>
                    <div>Account Mgr: ${currentAccountMgrFilter} (dropdown: ${document.getElementById('accountMgrFilter').value})</div>
                    <div>Client: ${currentClientFilter} (dropdown: ${document.getElementById('clientFilter').value})</div>
                `;
                
                log('[SIMULATION] Settings restored after page reload', 'success');
            } else {
                document.getElementById('dropdown-results').innerHTML = `
                    <div class="warning">‚ö†Ô∏è No settings to restore</div>
                `;
                log('[SIMULATION] No settings found to restore', 'warning');
            }
        }

        function updateDropdownsToCurrentState() {
            document.getElementById('solutionFilter').value = currentSolutionFilter;
            document.getElementById('accountMgrFilter').value = currentAccountMgrFilter;
            document.getElementById('clientFilter').value = currentClientFilter;
        }

        function toggleQuarter(quarter) {
            activeQuarters[quarter] = !activeQuarters[quarter];
            updateQuarterButtons();
            log(`[QUARTER] Q${quarter} toggled to ${activeQuarters[quarter]}`, 'info');
        }

        function updateQuarterButtons() {
            const buttons = document.querySelectorAll('.quarter-btn');
            buttons.forEach(btn => {
                const quarter = btn.dataset.quarter;
                btn.classList.toggle('active', activeQuarters[quarter]);
                btn.style.opacity = activeQuarters[quarter] ? '1' : '0.5';
            });
        }

        function saveQuarterState() {
            const saved = saveSettings();
            document.getElementById('quarter-results').innerHTML = `
                <div class="success">‚úÖ Quarter state saved</div>
                <div>Active quarters: ${Object.keys(activeQuarters).filter(q => activeQuarters[q]).join(', ')}</div>
            `;
        }

        function loadQuarterState() {
            const loaded = loadSettings();
            updateQuarterButtons();
            document.getElementById('quarter-results').innerHTML = `
                <div class="success">‚úÖ Quarter state loaded</div>
                <div>Active quarters: ${Object.keys(activeQuarters).filter(q => activeQuarters[q]).join(', ')}</div>
            `;
        }

        function setTableFilter(filter) {
            currentTableStatusFilter = filter;
            document.getElementById('filterOP100Btn').style.background = filter === 'OP100' ? '#007cba' : '';
            document.getElementById('filterOP100Btn').style.color = filter === 'OP100' ? 'white' : '';
            document.getElementById('filterLOSTBtn').style.background = filter === 'LOST' ? '#007cba' : '';
            document.getElementById('filterLOSTBtn').style.color = filter === 'LOST' ? 'white' : '';
            
            const saved = saveSettings();
            document.getElementById('table-results').innerHTML = `
                <div class="success">‚úÖ Table filter set to: ${filter}</div>
            `;
            log(`[TABLE] Filter set to: ${filter}`, 'info');
        }

        function setTableSort(col, dir) {
            currentSort = { col, dir };
            const saved = saveSettings();
            document.getElementById('table-results').innerHTML = `
                <div class="success">‚úÖ Table sort set</div>
                <div>Column: ${col}, Direction: ${dir === 1 ? 'ASC' : 'DESC'}</div>
            `;
            log(`[TABLE] Sort set to: ${col} ${dir === 1 ? 'ASC' : 'DESC'}`, 'info');
        }

        function setTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                document.body.style.background = '#1f2937';
                document.body.style.color = '#f9fafb';
            } else {
                document.documentElement.classList.remove('dark');
                document.body.style.background = '';
                document.body.style.color = '';
            }
            
            const saved = saveSettings();
            document.getElementById('theme-results').innerHTML = `
                <div class="success">‚úÖ Theme set to: ${theme}</div>
            `;
            log(`[THEME] Set to: ${theme}`, 'info');
        }

        function checkTheme() {
            const isDark = document.documentElement.classList.contains('dark');
            document.getElementById('theme-results').innerHTML = `
                <div class="info">Current theme: ${isDark ? 'dark' : 'light'}</div>
            `;
        }

        // Initialize on page load
        window.onload = function() {
            log('[INIT] Page loaded - checking for existing settings', 'info');
            
            const loaded = loadSettings();
            if (loaded) {
                updateDropdownsToCurrentState();
                updateQuarterButtons();
                setTableFilter(currentTableStatusFilter);
                log('[INIT] Existing settings loaded and applied', 'success');
            } else {
                log('[INIT] No existing settings found', 'info');
                updateQuarterButtons(); // Set default quarter state
            }
        };
    </script>
</body>
</html>