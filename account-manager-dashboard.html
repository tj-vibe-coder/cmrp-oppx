<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.jsdelivr.net https://cdn.tailwindcss.com https://cdn.sheetjs.com https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.tailwindcss.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data:; connect-src 'self' http://localhost:3000 https://cmrp-oppx.onrender.com https://cdn.jsdelivr.net;">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>oppX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="Logo/CMRP Logo Dark.svg">
    <link rel="alternate icon" href="Logo/CMRP Logo Light.svg">
    <link rel="stylesheet" href="styles.css?v=1750741234">
    
    <!-- Load configuration and utilities -->
    <script src="config.js"></script>
    <script src="api-utils.js"></script>
    <script src="shared-navigation.js?v=1750741456"></script>
    
    <!-- Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Realtime indicator styles */
        .realtime-indicator {
            animation: pulse-green 2s infinite;
        }
        
        @keyframes pulse-green {
            0%, 100% { color: #10b981; opacity: 1; }
            50% { color: #059669; opacity: 0.6; }
        }
        
        /* Account manager selector styles */
        .account-manager-selector {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .manager-quick-select {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        
        .manager-quick-btn {
            padding: 0.25rem 0.75rem;
            border: 1px solid var(--border-secondary);
            border-radius: 0.375rem;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .manager-quick-btn:hover {
            background: var(--bg-hover);
            border-color: var(--border-primary);
        }
        
        .manager-quick-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        /* Enhanced snapshot date controls */
        .snapshot-controls-enhanced {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .date-selector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .snapshot-date-option {
            padding: 0.75rem;
            border: 1px solid var(--border-secondary);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        
        .snapshot-date-option:hover {
            border-color: var(--primary-color);
            background: var(--bg-hover);
        }
        
        .snapshot-date-option.selected {
            border-color: var(--primary-color);
            background: rgba(59, 130, 246, 0.1);
        }
        
        .snapshot-date-option .date-label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        
        .snapshot-date-option .date-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        /* Activity status styles */
        .activity-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .activity-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }
        
        /* Enhanced dashboard card for account managers */
        .account-manager-card {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(59, 130, 246, 0.05) 100%);
            border: 1px solid var(--border-primary);
            border-radius: 1rem;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .account-manager-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #10b981, #f59e0b);
        }
        
        .manager-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #10b981);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.25rem;
        }
        
        /* Comparison mode toggle */
        .comparison-mode-toggle {
            display: flex;
            background: var(--bg-secondary);
            border-radius: 0.5rem;
            padding: 0.25rem;
            gap: 0.25rem;
        }
        
        .comparison-mode-toggle .toggle-option {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }
        
        .comparison-mode-toggle .toggle-option.active {
            background: var(--primary-color);
            color: white;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Include shared navigation -->
        <div id="shared-topbar"></div>
        <div id="shared-sidebar"></div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="content-header">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-primary flex items-center gap-2">
                            <span class="material-icons text-4xl">person</span>
                            Account Manager Dashboard
                            <span class="material-icons text-2xl realtime-indicator">radio_button_checked</span>
                        </h1>
                        <p class="text-secondary mt-1">Realtime metrics and performance tracking for active account managers only</p>
                    </div>
                    
                    <div class="activity-status">
                        <div class="activity-dot"></div>
                        <span id="lastUpdateTime">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Account Manager Selector -->
            <div class="account-manager-selector">
                <div class="flex items-center justify-between mb-3">
                    <label class="text-sm font-medium comparison-period-label">Select Account Manager:</label>
                    <button id="refreshManagersBtn" class="btn-secondary text-sm">
                        <span class="material-icons text-sm">refresh</span>
                        Refresh
                    </button>
                </div>
                
                <select id="accountManagerSelect" class="filter-dropdown w-full">
                    <option value="">Loading account managers...</option>
                </select>
                
                <div id="managerQuickSelect" class="manager-quick-select">
                    <!-- Quick select buttons will be populated here -->
                </div>
            </div>

            <!-- Enhanced Snapshot Controls -->
            <div class="snapshot-controls-enhanced">
                <div class="flex items-center justify-between mb-3">
                    <label class="text-sm font-medium comparison-period-label">Comparison Settings:</label>
                    <div class="comparison-mode-toggle">
                        <div class="toggle-option active" data-mode="weekly">Weekly</div>
                        <div class="toggle-option" data-mode="monthly">Monthly</div>
                        <div class="toggle-option" data-mode="custom">Custom</div>
                        <div class="toggle-option" data-mode="none">No Comparison</div>
                    </div>
                </div>
                
                <!-- Available snapshot dates will be shown here -->
                <div id="snapshotDatesContainer" class="date-selector-grid" style="display: none;">
                    <!-- Populated dynamically -->
                </div>
                
                <!-- Current comparison status -->
                <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded-lg">
                    <div class="flex items-center justify-between">
                        <span id="currentComparisonStatus" class="text-sm text-blue-700 dark:text-blue-300">
                            No comparison selected
                        </span>
                        <button id="createSnapshotBtn" class="btn-primary text-sm" style="display: none;">
                            Create Snapshot for Today
                        </button>
                    </div>
                </div>
            </div>

            <!-- Account Manager Info Card -->
            <div id="managerInfoCard" class="account-manager-card" style="display: none;">
                <div class="flex items-start justify-between">
                    <div class="flex items-center gap-4">
                        <div id="managerAvatar" class="manager-avatar">
                            AM
                        </div>
                        <div>
                            <h2 id="managerName" class="text-xl font-bold text-primary">Select an Account Manager</h2>
                            <p id="managerActivity" class="text-sm text-secondary">No activity data</p>
                            <div id="managerStats" class="flex items-center gap-4 mt-2 text-sm text-secondary">
                                <span id="totalOppsPreview">0 opportunities</span>
                                <span id="submittedPreview">0 submitted</span>
                                <span id="pipelinePreview">0 in pipeline</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-right">
                        <div id="lastActivity" class="text-sm text-secondary">Last activity: --</div>
                        <div id="todayUpdates" class="text-sm font-medium text-primary">0 updates today</div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Metrics Grid -->
            <div id="dashboardMetrics" class="mt-6" style="display: none;">
                <!-- Primary Metrics -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-primary mb-4">Primary Metrics</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="dashboard-card">
                            <div class="dashboard-title">Total Opportunities</div>
                            <div id="totalOpportunities" class="dashboard-value">--</div>
                            <div id="totalOpportunitiesChange" class="dashboard-change">--</div>
                        </div>
                        
                        <div class="dashboard-card">
                            <div class="dashboard-title">Submitted Count</div>
                            <div id="submittedCount" class="dashboard-value">--</div>
                            <div id="submittedCountChange" class="dashboard-change">--</div>
                        </div>
                        
                        <div class="dashboard-card">
                            <div class="dashboard-title">Submitted Amount</div>
                            <div id="submittedAmount" class="dashboard-value">--</div>
                            <div id="submittedAmountChange" class="dashboard-change">--</div>
                        </div>
                        
                        <div class="dashboard-card">
                            <div class="dashboard-title">Revised Count</div>
                            <div id="revisedCount" class="dashboard-value">--</div>
                            <div id="revisedCountChange" class="dashboard-change">--</div>
                        </div>
                    </div>
                </div>

                <!-- Opportunity Status Pipeline -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-primary mb-4">Opportunity Pipeline</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- OP100 Group -->
                        <div class="dashboard-card opportunity-status-card">
                            <div class="dashboard-title">OP100</div>
                            <div class="status-metrics">
                                <div class="metric-group">
                                    <div id="op100Count" class="dashboard-value">--</div>
                                    <div id="op100CountChange" class="dashboard-change">--</div>
                                </div>
                                <div class="metric-group">
                                    <div id="op100Amount" class="dashboard-value-secondary">--</div>
                                    <div id="op100AmountChange" class="dashboard-change">--</div>
                                </div>
                            </div>
                        </div>

                        <!-- OP90 Group -->
                        <div class="dashboard-card opportunity-status-card">
                            <div class="dashboard-title">OP90</div>
                            <div class="status-metrics">
                                <div class="metric-group">
                                    <div id="op90Count" class="dashboard-value">--</div>
                                    <div id="op90CountChange" class="dashboard-change">--</div>
                                </div>
                                <div class="metric-group">
                                    <div id="op90Amount" class="dashboard-value-secondary">--</div>
                                    <div id="op90AmountChange" class="dashboard-change">--</div>
                                </div>
                            </div>
                        </div>

                        <!-- OP60 Group -->
                        <div class="dashboard-card opportunity-status-card">
                            <div class="dashboard-title">OP60</div>
                            <div class="status-metrics">
                                <div class="metric-group">
                                    <div id="op60Count" class="dashboard-value">--</div>
                                    <div id="op60CountChange" class="dashboard-change">--</div>
                                </div>
                                <div class="metric-group">
                                    <div id="op60Amount" class="dashboard-value-secondary">--</div>
                                    <div id="op60AmountChange" class="dashboard-change">--</div>
                                </div>
                            </div>
                        </div>

                        <!-- OP30 Group -->
                        <div class="dashboard-card opportunity-status-card">
                            <div class="dashboard-title">OP30</div>
                            <div class="status-metrics">
                                <div class="metric-group">
                                    <div id="op30Count" class="dashboard-value">--</div>
                                    <div id="op30CountChange" class="dashboard-change">--</div>
                                </div>
                                <div class="metric-group">
                                    <div id="op30Amount" class="dashboard-value-secondary">--</div>
                                    <div id="op30AmountChange" class="dashboard-change">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Final Status Tracking -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-primary mb-4">Final Status</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Lost Group -->
                        <div class="dashboard-card final-status-card">
                            <div class="dashboard-title">Lost</div>
                            <div class="status-metrics">
                                <div class="metric-group">
                                    <div id="lostCount" class="dashboard-value">--</div>
                                    <div id="lostCountChange" class="dashboard-change">--</div>
                                </div>
                                <div class="metric-group">
                                    <div id="lostAmount" class="dashboard-value-secondary">--</div>
                                    <div id="lostAmountChange" class="dashboard-change">--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Declined -->
                        <div class="dashboard-card final-status-card">
                            <div class="dashboard-title">Declined</div>
                            <div class="status-metrics">
                                <div class="metric-group">
                                    <div id="declinedCount" class="dashboard-value">--</div>
                                    <div id="declinedCountChange" class="dashboard-change">--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Inactive -->
                        <div class="dashboard-card final-status-card">
                            <div class="dashboard-title">Inactive</div>
                            <div class="status-metrics">
                                <div class="metric-group">
                                    <div id="inactiveCount" class="dashboard-value">--</div>
                                    <div id="inactiveCountChange" class="dashboard-change">--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Other Status -->
                        <div class="dashboard-card final-status-card">
                            <div class="dashboard-title">Other Status</div>
                            <div class="status-metrics compact-metrics">
                                <div class="metric-row">
                                    <span class="metric-label">Ongoing:</span>
                                    <div id="ongoingCount" class="dashboard-value-compact">--</div>
                                    <div id="ongoingCountChange" class="dashboard-change-compact">--</div>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Pending:</span>
                                    <div id="pendingCount" class="dashboard-value-compact">--</div>
                                    <div id="pendingCountChange" class="dashboard-change-compact">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-primary mb-4">Visual Analytics</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Pipeline Chart -->
                        <div class="dashboard-card">
                            <h4 class="text-lg font-semibold text-primary mb-4">Pipeline Distribution</h4>
                            <div class="chart-container">
                                <canvas id="accountManagerPipelineChart" width="400" height="300"></canvas>
                            </div>
                        </div>

                        <!-- Status Chart -->
                        <div class="dashboard-card">
                            <h4 class="text-lg font-semibold text-primary mb-4">Status Overview</h4>
                            <div class="chart-container">
                                <canvas id="accountManagerStatusChart" width="400" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="text-center py-12">
                <div class="text-6xl text-gray-300 dark:text-gray-600 mb-4">ðŸ“Š</div>
                <h3 class="text-xl font-semibold text-primary mb-2">Select an Account Manager</h3>
                <p class="text-secondary">Choose an account manager from the dropdown above to view their realtime metrics and performance data.</p>
            </div>
        </div>
    </div>

    <!-- Load the account manager dashboard JavaScript -->
    <script src="account-manager-dashboard.js"></script>
</body>
</html>