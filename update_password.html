<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Password</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body class="min-h-screen bg-gray-100 dark:bg-gray-900 flex flex-col">
    <div class="simple-header">
        <div class="title-group">
            <a href="index.html" title="Go to Home" style="text-decoration: none; color: inherit;">
                <img id="cmrpLogo" src="Logo/CMRP Logo Light.svg" alt="CMRP Logo" style="height:2.2rem;width:auto;display:inline-block;vertical-align:middle;transition:filter 0.2s;cursor:pointer;" />
            </a>
            <span class="subtitle">Update Password</span>
        </div>
        <nav class="flex gap-2">
            <button id="themeToggle" class="nav-square-btn" title="Toggle between light and dark theme"><span class="material-icons">dark_mode</span></button>
            <a href="index.html" class="nav-square-btn" title="Go back to Opportunities Management">
                <span class="material-icons">home</span>
            </a>
            <!-- ...other nav buttons if any... -->
        </nav>
    </div>
    <main class="flex-1 flex items-center justify-center" style="padding-top:5.5rem; min-height:calc(100vh - 3.5rem);">
        <div class="w-full max-w-md bg-white dark:bg-gray-800 rounded-lg shadow-md p-8">
            <h2 class="text-2xl font-semibold mb-6 text-center text-gray-800 dark:text-white">Change Your Password</h2>
            <form id="updatePasswordForm" class="space-y-5">
                <div>
                    <label for="currentPassword" class="block text-sm font-medium mb-1">Current Password</label>
                    <input type="password" id="currentPassword" name="currentPassword" required class="w-full border border-gray-300 dark:border-gray-700 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white" autocomplete="current-password">
                </div>
                <div>
                    <label for="newPassword" class="block text-sm font-medium mb-1">New Password</label>
                    <input type="password" id="newPassword" name="newPassword" required minlength="8" maxlength="100" class="w-full border border-gray-300 dark:border-gray-700 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white" autocomplete="new-password">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Password must be 8-100 characters long</p>
                </div>
                <div>
                    <label for="confirmPassword" class="block text-sm font-medium mb-1">Confirm New Password</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" required minlength="8" maxlength="100" class="w-full border border-gray-300 dark:border-gray-700 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white" autocomplete="new-password">
                </div>
                <div id="formMessage" class="text-center text-sm mt-2"></div>
                <button type="submit" class="action-button w-full mt-2">Update Password</button>
            </form>
        </div>
    </main>
    
    <script>
    // --- Theme Management ---
    function applyTheme(theme) {
        const isDark = theme === 'dark';
        document.documentElement.classList.toggle('dark', isDark);
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        
        const themeToggle = document.getElementById('themeToggle');
        if (themeToggle) {
            const icon = themeToggle.querySelector('.material-icons');
            if (icon) icon.textContent = 'wb_sunny';
        }
        
        const logo = document.getElementById('cmrpLogo');
        if (logo) {
            logo.src = 'Logo/CMRP Logo Light.svg';
        }
    }

    function toggleTheme() {
        const currentTheme = localStorage.getItem('theme') || 'light';
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        applyTheme(newTheme);
    }

    // Initialize theme
    document.addEventListener('DOMContentLoaded', function() {
        const savedTheme = localStorage.getItem('theme') || 'dark'; // Default to dark
        applyTheme(savedTheme);
        
        const themeToggle = document.getElementById('themeToggle');
        if (themeToggle) {
            themeToggle.addEventListener('click', toggleTheme);
        }
    });

    // Sync theme changes across tabs/pages
    window.addEventListener('storage', function(e) {
        if (e.key === 'theme') {
            const newTheme = e.newValue || 'light';
            applyTheme(newTheme);
        }
    });
    
    document.getElementById('updatePasswordForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const messageDiv = document.getElementById('formMessage');
        messageDiv.textContent = '';
        messageDiv.className = 'text-center text-sm mt-2';

        if (newPassword.length < 8) {
            messageDiv.textContent = 'New password must be at least 8 characters.';
            messageDiv.classList.add('text-red-600');
            return;
        }
        if (newPassword.length > 100) {
            messageDiv.textContent = 'New password must be no more than 100 characters.';
            messageDiv.classList.add('text-red-600');
            return;
        }
        if (newPassword !== confirmPassword) {
            messageDiv.textContent = 'New passwords do not match.';
            messageDiv.classList.add('text-red-600');
            return;
        }
        try {
            const res = await fetch('/api/update-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('authToken')
                },
                body: JSON.stringify({ currentPassword, newPassword })
            });
            const data = await res.json();
            if (res.ok) {
                messageDiv.textContent = 'Password updated successfully!';
                messageDiv.classList.add('text-green-600');
                document.getElementById('updatePasswordForm').reset();
            } else {
                // Show detailed backend validation errors if present
                if (data.errors && Array.isArray(data.errors)) {
                    messageDiv.textContent = data.errors.map(e => e.msg).join(' ');
                } else {
                    messageDiv.textContent = data.error || data.message || 'Failed to update password.';
                }
                messageDiv.classList.add('text-red-600');
            }
        } catch (err) {
            messageDiv.textContent = 'An error occurred. Please try again.';
            messageDiv.classList.add('text-red-600');
        }
    });
    </script>
</body>
</html>
