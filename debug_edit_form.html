<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Edit Form</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: #155724; background: #d4edda; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .error { color: #721c24; background: #f8d7da; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .info { color: #0c5460; background: #d1ecf1; padding: 10px; border-radius: 4px; margin: 10px 0; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
        textarea { width: 100%; height: 300px; padding: 10px; font-family: monospace; font-size: 12px; border: 1px solid #ddd; border-radius: 4px; }
        .form-group { margin: 10px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üêõ Debug Edit Form Fix</h1>
        
        <div class="test-section">
            <h3>1. Authentication</h3>
            <button onclick="testAuth()" id="authBtn">Test Authentication</button>
            <div id="authResult"></div>
        </div>

        <div class="test-section">
            <h3>2. Load Test Opportunity</h3>
            <button onclick="loadTestOpportunity()" id="loadBtn" disabled>Load Test Opportunity</button>
            <div id="loadResult"></div>
        </div>

        <div class="test-section">
            <h3>3. Test Margin Field Handling</h3>
            <div class="form-group">
                <label for="marginInput">Margin Field (should handle percentage format):</label>
                <input type="number" id="marginInput" placeholder="Enter margin as percentage">
                <button onclick="testMarginInput()">Test Margin Input</button>
            </div>
            <div id="marginResult"></div>
        </div>

        <div class="test-section">
            <h3>4. Test PUT Request</h3>
            <button onclick="testPutRequest()" id="putBtn" disabled>Test PUT with Formatted Values</button>
            <div id="putResult"></div>
        </div>

        <div class="test-section">
            <h3>5. Server Response Log</h3>
            <textarea id="responseLog" readonly placeholder="Server responses will appear here..."></textarea>
        </div>
    </div>

    <script>
        let authToken = null;
        let testOpportunity = null;

        function log(message) {
            console.log(message);
            const logArea = document.getElementById('responseLog');
            logArea.value += `[${new Date().toLocaleTimeString()}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function getApiUrl(endpoint) {
            return (window.location.hostname === 'localhost' ? 'http://localhost:3000' : 'https://cmrp-opps-backend.onrender.com') + endpoint;
        }

        async function testAuth() {
            const btn = document.getElementById('authBtn');
            const result = document.getElementById('authResult');
            
            btn.disabled = true;
            result.innerHTML = '<div class="info">Testing authentication...</div>';

            try {
                const response = await fetch(getApiUrl('/api/login'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'reuel.rivera@cmrpautomation.com',
                        password: 'cmrp0601'
                    })
                });

                const data = await response.json();
                log(`Login response: ${response.status} - ${JSON.stringify(data)}`);

                if (response.ok && data.token) {
                    authToken = data.token;
                    localStorage.setItem('authToken', authToken);
                    
                    result.innerHTML = '<div class="success">‚úÖ Authentication successful!</div>';
                    document.getElementById('loadBtn').disabled = false;
                    
                    // Decode token to show user info
                    const payload = JSON.parse(atob(authToken.split('.')[1]));
                    log(`Authenticated as: ${payload.email} (${payload.accountType})`);
                } else {
                    result.innerHTML = `<div class="error">‚ùå Authentication failed: ${data.error}</div>`;
                }
            } catch (error) {
                log(`Authentication error: ${error.message}`);
                result.innerHTML = `<div class="error">‚ùå Authentication error: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
            }
        }

        async function loadTestOpportunity() {
            const btn = document.getElementById('loadBtn');
            const result = document.getElementById('loadResult');
            
            btn.disabled = true;
            result.innerHTML = '<div class="info">Loading test opportunity...</div>';

            try {
                const response = await fetch(getApiUrl('/api/opportunities'), {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();
                log(`Opportunities response: ${response.status} - Found ${data.length} opportunities`);

                if (response.ok && data.length > 0) {
                    testOpportunity = data[0]; // Use first opportunity
                    result.innerHTML = `
                        <div class="success">‚úÖ Loaded test opportunity: ${testOpportunity.opportunity_name || testOpportunity.uid}</div>
                        <div class="info">
                            <strong>Current values:</strong><br>
                            Margin: ${testOpportunity.margin || 'not set'}<br>
                            Final Amount: ${testOpportunity.final_amt || 'not set'}
                        </div>
                    `;
                    document.getElementById('putBtn').disabled = false;
                } else {
                    result.innerHTML = '<div class="error">‚ùå No opportunities found</div>';
                }
            } catch (error) {
                log(`Load opportunity error: ${error.message}`);
                result.innerHTML = `<div class="error">‚ùå Load error: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
            }
        }

        function testMarginInput() {
            const input = document.getElementById('marginInput');
            const result = document.getElementById('marginResult');
            
            const value = input.value;
            
            if (!value) {
                result.innerHTML = '<div class="info">Enter a value to test</div>';
                return;
            }
            
            // Test the margin field handling logic from app.js
            const formattedValue = value + '%';
            const cleanedValue = formattedValue.replace(/[%]/g, '').trim();
            const numericValue = parseFloat(cleanedValue);
            
            result.innerHTML = `
                <div class="info">
                    <strong>Testing margin input handling:</strong><br>
                    Original input: "${value}"<br>
                    Formatted as percentage: "${formattedValue}"<br>
                    Cleaned value: "${cleanedValue}"<br>
                    Numeric value: ${numericValue}<br>
                    Is valid: ${!isNaN(numericValue) && isFinite(numericValue)}
                </div>
            `;
            
            log(`Margin test - Input: ${value}, Formatted: ${formattedValue}, Cleaned: ${cleanedValue}, Numeric: ${numericValue}`);
        }

        async function testPutRequest() {
            const btn = document.getElementById('putBtn');
            const result = document.getElementById('putResult');
            
            if (!testOpportunity) {
                result.innerHTML = '<div class="error">‚ùå No test opportunity loaded</div>';
                return;
            }

            btn.disabled = true;
            result.innerHTML = '<div class="info">Testing PUT request with formatted values...</div>';

            // Test data with formatted values (similar to what the form might send)
            const testData = {
                ...testOpportunity,
                margin: '15%',          // Formatted percentage
                final_amt: '‚Ç±10,000.00' // Formatted currency
            };

            log(`Testing PUT with data: ${JSON.stringify(testData, null, 2)}`);

            try {
                const response = await fetch(getApiUrl(`/api/opportunities/${testOpportunity.uid}`), {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(testData)
                });

                const responseData = await response.text();
                log(`PUT response: ${response.status} - ${responseData}`);

                if (response.ok) {
                    result.innerHTML = '<div class="success">‚úÖ PUT request successful with formatted values!</div>';
                } else {
                    result.innerHTML = `
                        <div class="error">
                            ‚ùå PUT request failed: ${response.status}<br>
                            Response: ${responseData}
                        </div>
                    `;
                }
            } catch (error) {
                log(`PUT request error: ${error.message}`);
                result.innerHTML = `<div class="error">‚ùå PUT request error: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
            }
        }

        // Auto-run auth test on load
        document.addEventListener('DOMContentLoaded', () => {
            log('Debug Edit Form loaded');
            
            // Check if we already have a token
            const existingToken = localStorage.getItem('authToken');
            if (existingToken) {
                try {
                    const payload = JSON.parse(atob(existingToken.split('.')[1]));
                    if (payload.exp * 1000 > Date.now()) {
                        authToken = existingToken;
                        document.getElementById('authResult').innerHTML = '<div class="success">‚úÖ Using existing authentication</div>';
                        document.getElementById('loadBtn').disabled = false;
                        log('Using existing valid token');
                        return;
                    }
                } catch (e) {
                    // Invalid token, continue with login
                }
            }
            
            // Auto-login for testing
            setTimeout(() => {
                testAuth();
            }, 500);
        });
    </script>
</body>
</html>
