<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.jsdelivr.net https://cdn.tailwindcss.com https://cdn.sheetjs.com https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.tailwindcss.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data:; connect-src 'self' http://localhost:3000 https://cmrp-opps-backend.onrender.com;">
    <title>Function Restoration Verification</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: #f8fafc;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .status-box {
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
            font-weight: 500;
        }
        .status-pass {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        .status-fail {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        .status-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }
        .function-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .function-item {
            padding: 10px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }
        .function-exists {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .function-missing {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Function Restoration Verification</h1>
        <p>This page verifies that all missing functions have been properly restored to app.js after the truncation issue.</p>

        <div class="status-box status-warning">
            <strong>Issue Summary:</strong> The app.js file was accidentally truncated during an edit operation, causing several important functions to be lost. This test verifies the restoration.
        </div>

        <h2>üìã Critical Functions Check</h2>
        <div id="functionCheck">
            <!-- Function check results will be populated by JavaScript -->
        </div>

        <h2>üß™ Function Testing</h2>
        <div id="testResults">
            <!-- Test results will be populated by JavaScript -->
        </div>

        <h2>üìä Summary</h2>
        <div id="summary">
            <!-- Summary will be populated by JavaScript -->
        </div>
    </div>

    <!-- Load required scripts -->
    <script src="config.js"></script>
    <script src="app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const functionCheck = document.getElementById('functionCheck');
            const testResults = document.getElementById('testResults');
            const summary = document.getElementById('summary');

            // List of critical functions that should exist
            const criticalFunctions = [
                'getFieldOptions',
                'showEditRowModal', 
                'saveEditedOpportunity',
                'closeOpportunityModal',
                'duplicateOpportunity',
                'deleteOpportunity',
                'renderTable',
                'displayOpportunities',
                'updateSummaryCards',
                'updateOpportunityOnServer',
                'createOpportunityOnServer',
                'deleteOpportunityOnServer',
                'editOpportunity',
                'getApiUrl',
                'getUniqueValuesFromData',
                'initializeTable',
                'updateChangePasswordBtnVisibility',
                'showAuthErrorBanner',
                'hideAuthErrorBanner',
                'loadOpportunities',
                'reloadOpportunities',
                'setupModalEventListeners',
                'closeRevisionHistoryModal',
                'showCSVFormatterModal',
                'closeCSVFormatterModal'
            ];

            let existingFunctions = 0;
            let missingFunctions = 0;

            // Check if functions exist
            let checkHTML = '<div class="function-list">';
            
            criticalFunctions.forEach(funcName => {
                const exists = typeof window[funcName] === 'function';
                if (exists) {
                    existingFunctions++;
                    checkHTML += `<div class="function-item function-exists">‚úÖ ${funcName}</div>`;
                } else {
                    missingFunctions++;
                    checkHTML += `<div class="function-item function-missing">‚ùå ${funcName}</div>`;
                }
            });

            checkHTML += '</div>';
            functionCheck.innerHTML = checkHTML;

            // Run functional tests
            let testHTML = '';

            // Test 1: getFieldOptions function
            try {
                if (typeof getFieldOptions === 'function') {
                    const testOptions = getFieldOptions('opp_status');
                    if (testOptions && Array.isArray(testOptions)) {
                        testHTML += '<div class="status-box status-pass">‚úÖ <strong>getFieldOptions Test:</strong> Function returns valid array for opp_status</div>';
                    } else {
                        testHTML += '<div class="status-box status-warning">‚ö†Ô∏è <strong>getFieldOptions Test:</strong> Function exists but returns unexpected result</div>';
                    }
                } else {
                    testHTML += '<div class="status-box status-fail">‚ùå <strong>getFieldOptions Test:</strong> Function is missing</div>';
                }
            } catch (error) {
                testHTML += '<div class="status-box status-fail">‚ùå <strong>getFieldOptions Test:</strong> Error - ' + error.message + '</div>';
            }

            // Test 2: getApiUrl function
            try {
                if (typeof getApiUrl === 'function') {
                    const testUrl = getApiUrl('/test');
                    if (typeof testUrl === 'string' && testUrl.includes('/test')) {
                        testHTML += '<div class="status-box status-pass">‚úÖ <strong>getApiUrl Test:</strong> Function returns valid URL</div>';
                    } else {
                        testHTML += '<div class="status-box status-warning">‚ö†Ô∏è <strong>getApiUrl Test:</strong> Function exists but returns unexpected result</div>';
                    }
                } else {
                    testHTML += '<div class="status-box status-fail">‚ùå <strong>getApiUrl Test:</strong> Function is missing</div>';
                }
            } catch (error) {
                testHTML += '<div class="status-box status-fail">‚ùå <strong>getApiUrl Test:</strong> Error - ' + error.message + '</div>';
            }

            // Test 3: Check if DOM manipulation functions work
            try {
                if (typeof renderTable === 'function') {
                    // Test with empty data (should not throw error)
                    renderTable([]);
                    testHTML += '<div class="status-box status-pass">‚úÖ <strong>renderTable Test:</strong> Function executes without error</div>';
                } else {
                    testHTML += '<div class="status-box status-fail">‚ùå <strong>renderTable Test:</strong> Function is missing</div>';
                }
            } catch (error) {
                testHTML += '<div class="status-box status-warning">‚ö†Ô∏è <strong>renderTable Test:</strong> Function exists but has issues - ' + error.message + '</div>';
            }

            testResults.innerHTML = testHTML;

            // Generate summary
            const totalFunctions = criticalFunctions.length;
            const successRate = ((existingFunctions / totalFunctions) * 100).toFixed(1);
            
            let summaryHTML = '';
            if (missingFunctions === 0) {
                summaryHTML = `
                    <div class="status-box status-pass">
                        <strong>‚úÖ Restoration Complete!</strong><br>
                        All ${totalFunctions} critical functions have been successfully restored.<br>
                        Success Rate: ${successRate}% (${existingFunctions}/${totalFunctions})
                    </div>
                `;
            } else {
                summaryHTML = `
                    <div class="status-box status-fail">
                        <strong>‚ùå Restoration Incomplete</strong><br>
                        ${missingFunctions} function(s) are still missing out of ${totalFunctions} total.<br>
                        Success Rate: ${successRate}% (${existingFunctions}/${totalFunctions})
                    </div>
                `;
            }

            summary.innerHTML = summaryHTML;

            // Console output for debugging
            console.log('Function Restoration Check Results:');
            console.log(`- Existing Functions: ${existingFunctions}`);
            console.log(`- Missing Functions: ${missingFunctions}`);
            console.log(`- Success Rate: ${successRate}%`);
            
            if (missingFunctions > 0) {
                console.log('Missing Functions:', criticalFunctions.filter(func => typeof window[func] !== 'function'));
            }
        });
    </script>
</body>
</html>
