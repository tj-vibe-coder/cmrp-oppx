<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test SALES Auto-filter & Total Opportunities Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .info { color: #007bff; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        pre {
            background: #333;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .step {
            margin: 10px 0;
            padding: 10px;
            background: #e9ecef;
            border-left: 4px solid #007bff;
        }
        #testLog {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background: #f8f9fa;
        }
        .checklist {
            background: #e8f5e8;
            border: 1px solid #28a745;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        .checklist h4 {
            margin-top: 0;
            color: #28a745;
        }
        .checklist ul {
            margin: 10px 0;
        }
        .checklist li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß SALES Auto-filter & Total Opportunities Fix Test</h1>
        
        <div class="test-section">
            <h2>üìã Fixes Applied</h2>
            <div class="checklist">
                <h4>‚úÖ Fix 1: Total Opportunities Count</h4>
                <ul>
                    <li><strong>Issue:</strong> Total Opportunities dashboard card was not updating with filtered data</li>
                    <li><strong>Fix:</strong> Added <code>totalOpportunities.textContent = data.length</code> to <code>updateSummaryCounters()</code> function</li>
                    <li><strong>Location:</strong> app.js, lines ~2583</li>
                </ul>
            </div>
            
            <div class="checklist">
                <h4>‚úÖ Fix 2: SALES Role Auto-filtering</h4>
                <ul>
                    <li><strong>Issue:</strong> SALES role users had no automatic filtering applied on login</li>
                    <li><strong>Fix:</strong> Added account manager matching logic for SALES role in <code>mapUserRolesToFilters()</code></li>
                    <li><strong>Location:</strong> app.js, lines ~3393-3406</li>
                    <li><strong>Behavior:</strong> SALES role users now automatically filter by account manager matching their username</li>
                </ul>
            </div>
            
            <div class="checklist">
                <h4>‚úÖ Fix 3: Dashboard Updates on Auto-filtering</h4>
                <ul>
                    <li><strong>Enhancement:</strong> Auto-filtering now triggers dashboard updates using selective update system</li>
                    <li><strong>Applies to:</strong> Both role-based and username-based auto-filtering</li>
                    <li><strong>Location:</strong> app.js, lines ~3497 and ~3547</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <h2>üß™ Manual Test Steps</h2>
            
            <div class="step">
                <strong>Step 1:</strong> Open the main application
                <button onclick="openMainApp()">üöÄ Open Main App</button>
            </div>
            
            <div class="step">
                <strong>Step 2:</strong> Test Total Opportunities Count Fix
                <ul>
                    <li>Log in with any account</li>
                    <li>Note the "Total Opportunities" count in the dashboard</li>
                    <li>Apply a filter (Account Manager or Solutions)</li>
                    <li>‚úÖ <strong>Expected:</strong> Total Opportunities count should update to match filtered data</li>
                    <li>‚ùå <strong>Before fix:</strong> Total Opportunities stayed at original count</li>
                </ul>
            </div>
            
            <div class="step">
                <strong>Step 3:</strong> Test SALES Role Auto-filtering
                <ul>
                    <li>Log in with a SALES role account (or modify user role to SALES)</li>
                    <li>‚úÖ <strong>Expected:</strong> Account Manager filter should automatically be set to match the logged-in user</li>
                    <li>‚úÖ <strong>Expected:</strong> Dashboard should show filtered data immediately</li>
                    <li>‚ùå <strong>Before fix:</strong> No automatic filtering was applied</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <h2>üîç Debug Console Commands</h2>
            <p>Run these in browser console to debug and verify the fixes:</p>
            <button onclick="copyDebugScript()">üìã Copy Debug Script</button>
            <pre id="debugScript">
// Test Total Opportunities Update
function testTotalOpportunitiesUpdate() {
    console.log('=== Testing Total Opportunities Update ===');
    
    const totalOppsElement = document.getElementById('totalOpportunities');
    console.log('Total Opportunities element:', totalOppsElement);
    console.log('Current value:', totalOppsElement?.textContent);
    
    // Test updateSummaryCounters function
    if (typeof opportunities !== 'undefined' && typeof updateSummaryCounters === 'function') {
        console.log('Total opportunities in data:', opportunities.length);
        
        // Test with filtered data
        const filteredData = opportunities.slice(0, 10); // Simulate filtered data
        console.log('Testing with filtered data (10 items):', filteredData.length);
        updateSummaryCounters(filteredData);
        
        setTimeout(() => {
            console.log('Total Opportunities after update:', totalOppsElement?.textContent);
            console.log('Should match filtered count (10):', totalOppsElement?.textContent === '10' ? '‚úÖ PASS' : '‚ùå FAIL');
        }, 100);
    } else {
        console.log('‚ùå Functions not available - make sure you are on the main app page');
    }
}

// Test SALES Role Auto-filtering
function testSalesRoleAutoFilter() {
    console.log('=== Testing SALES Role Auto-filtering ===');
    
    // Check current user roles
    if (typeof getCurrentUserRoles === 'function') {
        const roles = getCurrentUserRoles();
        console.log('Current user roles:', roles);
        
        if (roles && roles.includes('SALES')) {
            console.log('‚úÖ User has SALES role');
            
            // Check account manager filter
            const accountMgrFilter = document.getElementById('accountMgrFilter');
            console.log('Account Manager filter element:', accountMgrFilter);
            console.log('Current account manager filter value:', accountMgrFilter?.value);
            
            // Test role mapping function
            if (typeof mapUserRolesToFilters === 'function' && typeof opportunities !== 'undefined') {
                const roleFilters = mapUserRolesToFilters(['SALES'], opportunities);
                console.log('Role-based filters for SALES:', roleFilters);
                
                if (roleFilters.accountManager) {
                    console.log('‚úÖ SALES role mapped to account manager:', roleFilters.accountManager);
                } else {
                    console.log('‚ùå No account manager filter applied for SALES role');
                }
            }
        } else {
            console.log('‚ÑπÔ∏è User does not have SALES role, testing may not be applicable');
        }
    } else {
        console.log('‚ùå getCurrentUserRoles function not available');
    }
}

// Test Auto-filter Function
function testAutoFilterFunction() {
    console.log('=== Testing Auto-filter Function ===');
    
    if (typeof applyAutoFiltersForUser === 'function') {
        console.log('Calling applyAutoFiltersForUser()...');
        applyAutoFiltersForUser();
        
        setTimeout(() => {
            // Check if filters were applied
            const accountMgrFilter = document.getElementById('accountMgrFilter');
            const solutionsFilter = document.getElementById('solutionsFilter');
            const picFilter = document.getElementById('picFilter');
            
            console.log('Filters after auto-filter:');
            console.log('- Account Manager:', accountMgrFilter?.value || 'none');
            console.log('- Solutions:', solutionsFilter?.value || 'none');
            console.log('- PIC:', picFilter?.value || 'none');
            
            // Check dashboard values
            const totalOpps = document.getElementById('totalOpportunities');
            console.log('Dashboard Total Opportunities:', totalOpps?.textContent);
        }, 500);
    } else {
        console.log('‚ùå applyAutoFiltersForUser function not available');
    }
}

// Run all tests
testTotalOpportunitiesUpdate();
testSalesRoleAutoFilter();
testAutoFilterFunction();
            </pre>
        </div>

        <div class="test-section">
            <h2>üìä Test Results Log</h2>
            <div id="testLog"></div>
            <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
        </div>

        <div class="test-section">
            <h2>‚úÖ Success Criteria</h2>
            <div class="checklist">
                <h4>Total Opportunities Count Fix:</h4>
                <ul>
                    <li>[ ] Total Opportunities dashboard card updates when filters are applied</li>
                    <li>[ ] Count matches the number of filtered rows in table</li>
                    <li>[ ] Count returns to original when filters are cleared</li>
                </ul>
                
                <h4>SALES Role Auto-filtering:</h4>
                <ul>
                    <li>[ ] SALES role users automatically have Account Manager filter applied on login</li>
                    <li>[ ] Filter matches the logged-in user's name</li>
                    <li>[ ] Dashboard shows filtered data immediately after login</li>
                    <li>[ ] Auto-filtering works with both role-based and username-based matching</li>
                </ul>
                
                <h4>Dashboard Update Integration:</h4>
                <ul>
                    <li>[ ] Dashboard updates when auto-filters are applied</li>
                    <li>[ ] Selective dashboard update system works correctly (only Account Manager and Solutions filters trigger updates)</li>
                    <li>[ ] No console errors when auto-filtering is applied</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <h2>üîß Troubleshooting</h2>
            <p><strong>If Total Opportunities doesn't update:</strong></p>
            <ul>
                <li>Check browser console for JavaScript errors</li>
                <li>Verify <code>totalOpportunities</code> DOM element exists</li>
                <li>Ensure <code>updateSummaryCounters()</code> is being called with filtered data</li>
                <li>Check that the selective dashboard update system is working</li>
            </ul>
            
            <p><strong>If SALES auto-filtering doesn't work:</strong></p>
            <ul>
                <li>Verify user has SALES role assigned</li>
                <li>Check that username can be matched to an account manager in the data</li>
                <li>Ensure <code>mapUserRolesToFilters()</code> is returning account manager filter</li>
                <li>Verify <code>applyAutoFiltersForUser()</code> is applying the filter</li>
            </ul>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = type;
            entry.innerHTML = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }

        function openMainApp() {
            window.open('http://localhost:3000', '_blank');
            log('üöÄ Main application opened! Now test the fixes.', 'info');
        }

        function copyDebugScript() {
            const script = document.getElementById('debugScript').textContent;
            navigator.clipboard.writeText(script).then(() => {
                log('üìã Debug script copied to clipboard! Paste it in browser console.', 'success');
            }).catch(() => {
                log('‚ùå Failed to copy script. Please copy manually.', 'error');
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('üîß SALES Auto-filter & Total Opportunities Fix Test Page loaded', 'info');
            log('üìù Both fixes have been applied to app.js', 'success');
            log('üìã Ready to test the functionality', 'info');
        });
    </script>
</body>
</html>
