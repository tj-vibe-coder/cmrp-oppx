<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Bulk Update Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            max-width: 800px; 
            margin: 0 auto; 
        }
        .test-section { 
            margin: 20px 0; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        input, button, select { margin: 5px; padding: 10px; }
        input[type="file"] { width: 100%; }
        textarea { width: 100%; height: 100px; }
        button { background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; white-space: pre-wrap; }
        .log { border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 4px; max-height: 300px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .sample-data { font-size: 0.9em; }
    </style>
</head>
<body>
    <h1>üß™ Excel Bulk Update Test</h1>
    
    <div class="test-section info">
        <h3>üìã Test Purpose</h3>
        <p>This test verifies the Excel bulk update functionality for revision numbers, final amounts, and margins.</p>
        
        <h4>üîß Features being tested:</h4>
        <ul>
            <li><strong>Excel File Processing:</strong> Reading Excel files with password support</li>
            <li><strong>Column Mapping:</strong> Flexible column name matching</li>
            <li><strong>Data Validation:</strong> Parsing financial data (currency, percentages)</li>
            <li><strong>Bulk Updates:</strong> Updating multiple opportunities at once</li>
            <li><strong>Error Handling:</strong> Invalid UIDs, data format issues</li>
        </ul>
    </div>

    <div class="test-section">
        <h3>1Ô∏è‚É£ Authentication Check</h3>
        <button onclick="checkAuth()">Check Auth Token</button>
        <div id="auth-result"></div>
    </div>

    <div class="test-section">
        <h3>2Ô∏è‚É£ Sample Excel Data Format</h3>
        <p>Your Excel file should have these columns (case-insensitive):</p>
        <table class="sample-data">
            <thead>
                <tr>
                    <th>Option 1: UID</th>
                    <th>Option 2: Proposal Code</th>
                    <th>Revision Number</th>
                    <th>Final Amount</th>
                    <th>Margin</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>opp-123-abc</td>
                    <td>CMRP25060304</td>
                    <td>2</td>
                    <td>‚Ç±1,500,000</td>
                    <td>15%</td>
                </tr>
                <tr>
                    <td>453c5db8-3bb0-415c-beef-aadb3b760436</td>
                    <td>CMRP25060305</td>
                    <td>3</td>
                    <td>$25,000.50</td>
                    <td>20.5</td>
                </tr>
            </tbody>
        </table>
        <div class="info">
            <strong>CMRP Calcsheet Format:</strong> For files named like "CMRP25060304-PCS001-00 SLTEC Fortigate Renewal.xlsx", 
            the system can automatically extract the proposal code and revision number from the filename!
        </div>
        <div class="warning">
            <strong>Note:</strong> Currency symbols (‚Ç±, $) and commas in amounts are automatically removed. 
            Percentage symbols (%) in margins are automatically handled.
        </div>
    </div>

    <div class="test-section">
        <h3>3Ô∏è‚É£ Excel File Upload Test</h3>
        <form id="testForm" enctype="multipart/form-data">
            <div>
                <label for="testFile">Select Excel File (.xlsx, .xls):</label><br>
                <input type="file" id="testFile" name="excelFile" accept=".xlsx,.xls" required>
            </div>
            <div>
                <label for="testPassword">Password (if encrypted):</label><br>
                <input type="password" id="testPassword" name="password" placeholder="Leave blank if not encrypted">
            </div>
            <button type="button" id="testButton" onclick="testExcelUpload()">Test Upload</button>
        </form>
        
        <div id="test-progress" style="display: none;">
            <div style="background: #e9ecef; border-radius: 4px; height: 20px; margin: 10px 0;">
                <div id="test-progress-bar" style="background: #007bff; height: 100%; border-radius: 4px; width: 0%; transition: width 0.3s;"></div>
            </div>
            <p id="test-status">Processing...</p>
        </div>
        
        <div id="test-results"></div>
    </div>

    <div class="test-section">
        <h3>4Ô∏è‚É£ API Endpoint Test</h3>
        <button onclick="testAPIEndpoint()">Test API Directly</button>
        <div id="api-test-results"></div>
    </div>

    <div class="test-section">
        <h3>üìù Debug Logs</h3>
        <button onclick="clearLogs()">Clear Logs</button>
        <div id="debug-logs" class="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `[${timestamp}] ${message}`;
            document.getElementById('debug-logs').appendChild(div);
            document.getElementById('debug-logs').scrollTop = document.getElementById('debug-logs').scrollHeight;
        }
        
        function clearLogs() {
            document.getElementById('debug-logs').innerHTML = '';
        }
        
        async function checkAuth() {
            log('üîê Checking authentication...', 'info');
            
            const token = localStorage.getItem('authToken');
            const resultDiv = document.getElementById('auth-result');
            
            if (!token) {
                resultDiv.innerHTML = '<div class="error">‚ùå No auth token found. Please login at <a href="/">main app</a></div>';
                log('‚ùå No auth token found', 'error');
                return false;
            }
            
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const exp = new Date(payload.exp * 1000);
                const now = new Date();
                
                if (exp > now) {
                    resultDiv.innerHTML = `<div class="success">‚úÖ Auth token valid until ${exp.toLocaleString()}</div>`;
                    log('‚úÖ Auth token is valid', 'success');
                    return true;
                } else {
                    resultDiv.innerHTML = '<div class="error">‚ùå Auth token expired. Please login again.</div>';
                    log('‚ùå Auth token expired', 'error');
                    return false;
                }
            } catch (e) {
                resultDiv.innerHTML = '<div class="error">‚ùå Invalid auth token format</div>';
                log('‚ùå Invalid auth token format', 'error');
                return false;
            }
        }
        
        async function testExcelUpload() {
            log('üìä Starting Excel upload test...', 'info');
            
            const fileInput = document.getElementById('testFile');
            const passwordInput = document.getElementById('testPassword');
            const progressDiv = document.getElementById('test-progress');
            const progressBar = document.getElementById('test-progress-bar');
            const statusText = document.getElementById('test-status');
            const resultsDiv = document.getElementById('test-results');
            const testButton = document.getElementById('testButton');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                log('‚ùå No file selected', 'error');
                alert('Please select an Excel file to test.');
                return;
            }
            
            // Check auth first
            const authValid = await checkAuth();
            if (!authValid) {
                log('‚ùå Authentication required for testing', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const password = passwordInput.value.trim();
            
            log(`üìÅ Testing file: ${file.name} (${file.size} bytes)`, 'info');
            if (password) log('üîí Password provided for encrypted file', 'info');
            
            // Show progress
            progressDiv.style.display = 'block';
            resultsDiv.innerHTML = '';
            testButton.disabled = true;
            
            try {
                // Create FormData
                const formData = new FormData();
                formData.append('excelFile', file);
                if (password) {
                    formData.append('password', password);
                }
                
                // Update progress
                progressBar.style.width = '30%';
                statusText.textContent = 'Uploading file...';
                log('üì§ Sending request to /api/opportunities/bulk-update-excel', 'info');
                
                // Get auth token
                const token = localStorage.getItem('authToken');
                
                // Upload and process
                progressBar.style.width = '60%';
                statusText.textContent = 'Processing Excel data...';
                
                const response = await fetch('/api/opportunities/bulk-update-excel', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                progressBar.style.width = '90%';
                statusText.textContent = 'Getting results...';
                
                const result = await response.json();
                
                progressBar.style.width = '100%';
                statusText.textContent = 'Complete!';
                
                log(`üì° Response: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                log(`üìã Result: ${JSON.stringify(result, null, 2)}`, 'info');
                
                // Hide progress and show results
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                    showTestResults(result, response.ok);
                }, 1000);
                
            } catch (error) {
                log(`‚ùå Test error: ${error.message}`, 'error');
                progressDiv.style.display = 'none';
                showTestResults({
                    success: false,
                    error: error.message,
                    details: 'Network error or server unavailable'
                }, false);
            } finally {
                testButton.disabled = false;
            }
        }
        
        function showTestResults(result, success) {
            const resultsDiv = document.getElementById('test-results');
            
            if (success && result.success) {
                resultsDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Test Successful!</h4>
                        <p><strong>Records Updated:</strong> ${result.updated}</p>
                        <p><strong>Errors:</strong> ${result.errors}</p>
                        ${result.results ? `<pre>${JSON.stringify(result.results, null, 2)}</pre>` : ''}
                    </div>
                `;
                log(`‚úÖ Test completed successfully: ${result.updated} updated, ${result.errors} errors`, 'success');
            } else {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Test Failed</h4>
                        <p><strong>Error:</strong> ${result.error || 'Unknown error'}</p>
                        ${result.details ? `<p><strong>Details:</strong> ${result.details}</p>` : ''}
                        ${result.results ? `<pre>${JSON.stringify(result.results, null, 2)}</pre>` : ''}
                    </div>
                `;
                log(`‚ùå Test failed: ${result.error || 'Unknown error'}`, 'error');
            }
        }
        
        async function testAPIEndpoint() {
            log('üöÄ Testing API endpoint directly...', 'info');
            
            const resultDiv = document.getElementById('api-test-results');
            
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('No auth token found');
                }
                
                // Test a simple request to check if endpoint exists
                const response = await fetch('/api/opportunities/bulk-update-excel', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                    // No body - this should trigger "No file uploaded" error
                });
                
                const result = await response.json();
                
                log(`üì° API Endpoint Response: ${response.status}`, response.status === 400 ? 'success' : 'warning');
                log(`üìã Expected "No file uploaded" error: ${JSON.stringify(result)}`, 'info');
                
                if (response.status === 400 && result.error && result.error.includes('No file uploaded')) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ API Endpoint Working!</h4>
                            <p>The endpoint correctly returned a "No file uploaded" error, confirming it's accessible and working.</p>
                            <pre>${JSON.stringify(result, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="warning">
                            <h4>‚ö†Ô∏è Unexpected Response</h4>
                            <p>The API responded but not as expected. This might still be OK.</p>
                            <p><strong>Status:</strong> ${response.status}</p>
                            <pre>${JSON.stringify(result, null, 2)}</pre>
                        </div>
                    `;
                }
                
            } catch (error) {
                log(`‚ùå API test error: ${error.message}`, 'error');
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå API Test Failed</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p>The API endpoint may not be available or there's a network issue.</p>
                    </div>
                `;
            }
        }
        
        // Auto-check auth on page load
        window.onload = () => {
            log('üöÄ Excel Bulk Update Test initialized', 'info');
            checkAuth();
        };
    </script>
</body>
</html>