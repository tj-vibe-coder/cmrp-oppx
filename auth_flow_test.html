<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth Flow Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .step { margin: 10px 0; padding: 10px; border-left: 3px solid #007bff; background: #f8f9fa; }
        button { padding: 10px 20px; margin: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>Authentication Flow Test</h1>
    
    <div class="step">
        <h3>Step 1: Clear Everything</h3>
        <button onclick="clearAll()">Clear localStorage & Cookies</button>
        <div id="clear-result"></div>
    </div>

    <div class="step">
        <h3>Step 2: Test Login</h3>
        <input type="email" id="email" placeholder="Email" value="reuelrivera@gmail.com">
        <input type="password" id="password" placeholder="Password" value="password123">
        <button onclick="testLogin()">Login</button>
        <div id="login-result"></div>
    </div>

    <div class="step">
        <h3>Step 3: Verify Token Storage</h3>
        <button onclick="checkToken()">Check Token</button>
        <div id="token-result"></div>
    </div>

    <div class="step">
        <h3>Step 4: Manual Redirect Test</h3>
        <button onclick="manualRedirect()">Redirect to Index</button>
        <div id="redirect-result"></div>
    </div>

    <script>
        function clearAll() {
            localStorage.clear();
            sessionStorage.clear();
            document.getElementById('clear-result').innerHTML = '<span class="success">‚úÖ Storage cleared</span>';
        }

        async function testLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const resultDiv = document.getElementById('login-result');

            try {
                resultDiv.innerHTML = '<span class="info">üîÑ Logging in...</span>';

                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (!response.ok || !data.token) {
                    throw new Error(data.error || 'Login failed');
                }

                // Store token
                localStorage.setItem('authToken', data.token);
                
                // Verify storage immediately
                const stored = localStorage.getItem('authToken');
                
                resultDiv.innerHTML = `
                    <span class="success">‚úÖ Login successful</span><br>
                    <span class="info">Token stored: ${!!stored}</span><br>
                    <span class="info">Token preview: ${data.token.substring(0, 50)}...</span>
                `;

            } catch (error) {
                resultDiv.innerHTML = `<span class="error">‚ùå Login failed: ${error.message}</span>`;
            }
        }

        function checkToken() {
            const resultDiv = document.getElementById('token-result');
            const token = localStorage.getItem('authToken');

            if (!token) {
                resultDiv.innerHTML = '<span class="error">‚ùå No token found</span>';
                return;
            }

            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const now = Date.now() / 1000;
                const isExpired = payload.exp && payload.exp < now;
                const timeLeft = payload.exp ? (payload.exp - now) : 'No expiration';

                resultDiv.innerHTML = `
                    <span class="success">‚úÖ Token found</span><br>
                    <span class="info">Expires: ${new Date(payload.exp * 1000).toLocaleString()}</span><br>
                    <span class="info">Time left: ${Math.round(timeLeft)} seconds</span><br>
                    <span class="${isExpired ? 'error' : 'success'}">Is expired: ${isExpired}</span><br>
                    <span class="info">User: ${payload.email}</span>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">‚ùå Invalid token: ${error.message}</span>`;
            }
        }

        function manualRedirect() {
            const resultDiv = document.getElementById('redirect-result');
            const token = localStorage.getItem('authToken');

            if (!token) {
                resultDiv.innerHTML = '<span class="error">‚ùå No token to test redirect</span>';
                return;
            }

            resultDiv.innerHTML = '<span class="info">üîÑ Redirecting in 2 seconds...</span>';
            
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 2000);
        }

        // Check initial state
        window.addEventListener('load', function() {
            checkToken();
        });
    </script>
</body>
</html>
