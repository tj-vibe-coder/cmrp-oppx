<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OP100 Amount Analysis Tool</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .analysis-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .debug-output { background: #f5f5f5; padding: 10px; margin: 10px 0; white-space: pre-wrap; font-size: 12px; }
        button { padding: 10px 20px; margin: 5px; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <h1>OP100 Amount Analysis Tool</h1>
    
    <div class="analysis-section">
        <h3>Analysis Controls</h3>
        <button onclick="analyzeOP100Data()">Analyze Current OP100 Data</button>
        <button onclick="compareWithSnapshot()">Compare with Snapshot</button>
        <button onclick="clearOutput()">Clear Output</button>
    </div>

    <div class="analysis-section">
        <h3>Current OP100 Data Analysis</h3>
        <div id="currentAnalysis" class="debug-output">Click "Analyze Current OP100 Data" to start...</div>
    </div>

    <div class="analysis-section">
        <h3>Snapshot Comparison</h3>
        <div id="snapshotComparison" class="debug-output">Click "Compare with Snapshot" to start...</div>
    </div>

    <div class="analysis-section">
        <h3>Delta Calculation Details</h3>
        <div id="deltaDetails" class="debug-output">Delta calculations will appear here...</div>
    </div>

    <script>
        let currentOutput = document.getElementById('currentAnalysis');
        let snapshotOutput = document.getElementById('snapshotComparison');
        let deltaOutput = document.getElementById('deltaDetails');

        function log(element, message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            element.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
        }

        function clearOutput() {
            currentOutput.innerHTML = '';
            snapshotOutput.innerHTML = '';
            deltaOutput.innerHTML = '';
        }

        async function analyzeOP100Data() {
            currentOutput.innerHTML = '';
            log(currentOutput, 'Fetching current dashboard data...');
            
            try {
                const response = await fetch('/api/opportunities');
                if (!response.ok) {
                    log(currentOutput, `Failed to fetch data: ${response.statusText}`, 'error');
                    return;
                }
                
                const data = await response.json();
                log(currentOutput, `Total opportunities fetched: ${data.length}`, 'success');
                
                const op100Opps = data.filter(d => d.opp_status?.toLowerCase() === 'op100');
                log(currentOutput, `OP100 opportunities found: ${op100Opps.length}`, 'success');
                
                let totalOP100Amount = 0;
                
                op100Opps.forEach((opp, index) => {
                    const amount = parseFloat(opp.final_amt) || 0;
                    totalOP100Amount += amount;
                    log(currentOutput, `OP100 ${index + 1}: ${opp.company || 'N/A'} - ₱${amount.toLocaleString()}`, 'info');
                });
                
                log(currentOutput, `Total OP100 Amount: ₱${totalOP100Amount.toLocaleString()}`, 'success');
                log(currentOutput, `Total OP100 Amount (formatted): ₱${(totalOP100Amount / 1000000).toFixed(1)}M`, 'success');
                
                window.currentOP100Data = {
                    count: op100Opps.length,
                    amount: totalOP100Amount
                };
                
            } catch (error) {
                log(currentOutput, `Error analyzing OP100 data: ${error.message}`, 'error');
            }
        }

        async function fetchWeeklySnapshot() {
            try {
                const response = await fetch(getApiUrl(window.APP_CONFIG.ENDPOINTS.SNAPSHOTS + '/weekly'), {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                displaySnapshotData(data);
            } catch (error) {
                console.error('Error fetching weekly snapshot:', error);
                document.getElementById('snapshotData').innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }

        async function compareWithSnapshot() {
            snapshotOutput.innerHTML = '';
            log(snapshotOutput, 'Fetching snapshot data...');
            
            try {
                const response = await fetch('/api/snapshots/weekly');
                if (!response.ok) {
                    log(snapshotOutput, `Failed to fetch snapshot: ${response.statusText}`, 'error');
                    return;
                }
                
                const snapshotResult = await response.json();
                log(snapshotOutput, `Raw snapshot response: ${JSON.stringify(snapshotResult, null, 2)}`);
                
                let snapshot;
                if (snapshotResult.success && snapshotResult.data) {
                    snapshot = snapshotResult.data;
                } else if (snapshotResult.id && snapshotResult.snapshot_type) {
                    snapshot = snapshotResult;
                }
                
                if (!snapshot) {
                    log(snapshotOutput, 'No valid snapshot data found', 'error');
                    return;
                }
                
                const snapshotOP100Count = snapshot.op100_count;
                const snapshotOP100Amount = parseFloat(snapshot.op100_amount) || 0;
                
                log(snapshotOutput, `Snapshot OP100 Count: ${snapshotOP100Count}`, 'success');
                log(snapshotOutput, `Snapshot OP100 Amount: ₱${snapshotOP100Amount.toLocaleString()}`, 'success');
                log(snapshotOutput, `Snapshot OP100 Amount (formatted): ₱${(snapshotOP100Amount / 1000000).toFixed(1)}M`, 'success');
                log(snapshotOutput, `Snapshot Date: ${snapshot.saved_date || 'N/A'}`, 'success');
                
                window.snapshotOP100Data = {
                    count: snapshotOP100Count,
                    amount: snapshotOP100Amount,
                    date: snapshot.saved_date
                };
                
                if (window.currentOP100Data) {
                    calculateDelta();
                }
                
            } catch (error) {
                log(snapshotOutput, `Error fetching snapshot: ${error.message}`, 'error');
            }
        }

        function calculateDelta() {
            deltaOutput.innerHTML = '';
            log(deltaOutput, 'Calculating OP100 delta...');
            
            if (!window.currentOP100Data || !window.snapshotOP100Data) {
                log(deltaOutput, 'Missing current or snapshot data for delta calculation', 'error');
                return;
            }
            
            const current = window.currentOP100Data;
            const snapshot = window.snapshotOP100Data;
            
            const countDelta = current.count - snapshot.count;
            log(deltaOutput, `Count Delta: ${current.count} - ${snapshot.count} = ${countDelta}`, 'success');
            
            const amountDelta = current.amount - snapshot.amount;
            log(deltaOutput, `Amount Delta: ₱${current.amount.toLocaleString()} - ₱${snapshot.amount.toLocaleString()} = ₱${amountDelta.toLocaleString()}`, 
                amountDelta >= 0 ? 'success' : 'warning');
            
            const formattedDelta = amountDelta / 1000000;
            log(deltaOutput, `Formatted Amount Delta: ₱${formattedDelta.toFixed(1)}M`, amountDelta >= 0 ? 'success' : 'warning');
            
            if (amountDelta < 0) {
                log(deltaOutput, `⚠️ NEGATIVE DELTA DETECTED: This explains the -${Math.abs(formattedDelta).toFixed(1)}M you're seeing`, 'warning');
                log(deltaOutput, `Current OP100 amount (₱${(current.amount/1000000).toFixed(1)}M) is LESS than snapshot (₱${(snapshot.amount/1000000).toFixed(1)}M)`, 'warning');
                log(deltaOutput, `Possible reasons: OP100 opportunities moved to different status, amount corrections, or data changes`, 'warning');
            } else {
                log(deltaOutput, `✅ Positive delta: Current OP100 amount increased by ₱${formattedDelta.toFixed(1)}M`, 'success');
            }
        }

        window.addEventListener('load', () => {
            setTimeout(() => {
                analyzeOP100Data().then(() => {
                    setTimeout(compareWithSnapshot, 1000);
                });
            }, 500);
        });
    </script>
</body>
</html> 