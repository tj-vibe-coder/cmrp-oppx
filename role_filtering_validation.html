<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Role-Based Filtering End-to-End Validation</title>
    <script src="config.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .warning { background-color: #fff3cd; border-color: #ffeeba; color: #856404; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        button { margin: 5px; padding: 8px 15px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background: #0056b3; }
        .test-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .step { margin: 10px 0; padding: 10px; border-left: 4px solid #007bff; background: #f8f9fa; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; font-size: 12px; max-height: 200px; }
    </style>
</head>
<body>
    <h1>üéØ Role-Based Filtering End-to-End Validation</h1>
    <p><strong>Objective:</strong> Validate complete role-based auto-filtering functionality across the CMRP system</p>

    <!-- Quick Status Check -->
    <div class="test-section info">
        <h2>üìä Current System Status</h2>
        <button onclick="checkSystemStatus()">Check System Status</button>
        <div id="systemStatus"></div>
    </div>

    <!-- Step-by-Step Validation -->
    <div class="test-section">
        <h2>üîÑ Step-by-Step Validation Process</h2>
        
        <div class="step">
            <h3>Step 1: Verify Role System Updates</h3>
            <button onclick="validateRoleSystem()">Validate Role System</button>
            <div id="roleSystemResult"></div>
        </div>

        <div class="step">
            <h3>Step 2: Test User Authentication with New Roles</h3>
            <button onclick="testUserAuthentication()">Test Authentication</button>
            <div id="authResult"></div>
        </div>

        <div class="step">
            <h3>Step 3: Validate Role-Based Filter Mapping</h3>
            <button onclick="testFilterMapping()">Test Filter Mapping</button>
            <div id="filterMappingResult"></div>
        </div>

        <div class="step">
            <h3>Step 4: Test Dashboard Auto-Filtering</h3>
            <button onclick="testDashboardFiltering()">Test Dashboard Filtering</button>
            <div id="dashboardFilteringResult"></div>
        </div>

        <div class="step">
            <h3>Step 5: Verify Fallback Mechanism</h3>
            <button onclick="testFallbackMechanism()">Test Fallback</button>
            <div id="fallbackResult"></div>
        </div>
    </div>

    <!-- Comprehensive Test Report -->
    <div class="test-section">
        <h2>üìà Comprehensive Validation</h2>
        <button onclick="runCompleteValidation()">Run Complete Validation</button>
        <button onclick="downloadValidationReport()">Download Report</button>
        <div id="validationReport"></div>
    </div>

    <!-- Real-time Testing -->
    <div class="test-section">
        <h2>üî¨ Live Testing Interface</h2>
        <div class="test-grid">
            <div>
                <h4>Test Role Scenarios</h4>
                <select id="testRole">
                    <option value="DS">DS (Digital Solutions)</option>
                    <option value="SE">SE (Smart Energy)</option>
                    <option value="Sales">Sales</option>
                    <option value="Admin">Admin</option>
                </select>
                <button onclick="simulateRoleFiltering()">Simulate Role Filtering</button>
            </div>
            <div>
                <h4>Test Data Scenarios</h4>
                <button onclick="loadTestData()">Load Test Data</button>
                <button onclick="validateFilterLogic()">Validate Filter Logic</button>
            </div>
        </div>
        <div id="liveTestResult"></div>
    </div>

    <script>
        let validationResults = [];
        let testData = null;

        // System Status Check
        async function checkSystemStatus() {
            const statusDiv = document.getElementById('systemStatus');
            statusDiv.innerHTML = '<div class="info">Checking system status...</div>';
            
            try {
                // Check if server is running
                const serverCheck = await fetch('/api/opportunities', {
                    headers: localStorage.getItem('authToken') ? {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    } : {}
                }).catch(() => null);
                
                const serverStatus = serverCheck ? '‚úÖ Server Running' : '‚ùå Server Not Responding';
                
                // Check authentication
                const token = localStorage.getItem('authToken');
                let authStatus = '‚ùå Not Authenticated';
                let currentRoles = [];
                
                if (token) {
                    try {
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        authStatus = `‚úÖ Authenticated as: ${payload.email}`;
                        currentRoles = payload.roles || [];
                    } catch (e) {
                        authStatus = '‚ö†Ô∏è Invalid Token';
                    }
                }
                
                // Check if role functions are available
                const functionsStatus = [
                    { name: 'getCurrentUserRoles', available: typeof getCurrentUserRoles === 'function' },
                    { name: 'mapUserRolesToFilters', available: typeof mapUserRolesToFilters === 'function' },
                    { name: 'applyAutoFiltersForUser', available: typeof applyAutoFiltersForUser === 'function' }
                ];
                
                statusDiv.innerHTML = `
                    <div class="info">
                        <h4>System Status Report</h4>
                        <p><strong>Server:</strong> ${serverStatus}</p>
                        <p><strong>Authentication:</strong> ${authStatus}</p>
                        <p><strong>Current Roles:</strong> ${currentRoles.join(', ') || 'None'}</p>
                        <p><strong>Role Functions:</strong></p>
                        <ul>
                            ${functionsStatus.map(f => `<li>${f.available ? '‚úÖ' : '‚ùå'} ${f.name}</li>`).join('')}
                        </ul>
                    </div>
                `;
                
                validationResults.push({
                    test: 'System Status',
                    result: serverCheck ? 'PASS' : 'FAIL',
                    details: { serverStatus, authStatus, currentRoles, functionsStatus }
                });
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">‚ùå System check failed: ${error.message}</div>`;
                validationResults.push({
                    test: 'System Status',
                    result: 'ERROR',
                    error: error.message
                });
            }
        }

        // Step 1: Validate Role System
        async function validateRoleSystem() {
            const resultDiv = document.getElementById('roleSystemResult');
            resultDiv.innerHTML = '<div class="info">Validating role system updates...</div>';
            
            try {
                // Test admin login to check role system
                const loginResponse = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'reuel.rivera@cmrpautomation.com',
                        password: 'cmrp0601'
                    })
                });

                if (!loginResponse.ok) {
                    throw new Error('Admin login failed');
                }

                const loginResult = await loginResponse.json();
                localStorage.setItem('authToken', loginResult.token);
                
                const payload = JSON.parse(atob(loginResult.token.split('.')[1]));
                const roles = payload.roles || [];
                
                // Check if roles include the new role structure
                const expectedRoles = ['DS', 'SE', 'Sales', 'Admin'];
                const hasNewRoles = expectedRoles.some(role => roles.includes(role));
                
                if (hasNewRoles) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ Role System Validation PASSED<br>
                            Current roles: ${roles.join(', ')}<br>
                            New role structure detected: ${hasNewRoles ? 'Yes' : 'No'}
                        </div>
                    `;
                    validationResults.push({
                        test: 'Role System Validation',
                        result: 'PASS',
                        roles: roles
                    });
                } else {
                    resultDiv.innerHTML = `
                        <div class="warning">
                            ‚ö†Ô∏è Role System Validation PARTIAL<br>
                            Current roles: ${roles.join(', ')}<br>
                            Note: May still be using legacy role structure
                        </div>
                    `;
                    validationResults.push({
                        test: 'Role System Validation',
                        result: 'PARTIAL',
                        roles: roles
                    });
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Role system validation failed: ${error.message}</div>`;
                validationResults.push({
                    test: 'Role System Validation',
                    result: 'FAIL',
                    error: error.message
                });
            }
        }

        // Step 2: Test User Authentication
        async function testUserAuthentication() {
            const resultDiv = document.getElementById('authResult');
            resultDiv.innerHTML = '<div class="info">Testing user authentication with new roles...</div>';
            
            const testUsers = [
                { email: 'ds.test@cmrp.com', password: 'testpass123', expectedRole: 'DS' },
                { email: 'se.test@cmrp.com', password: 'testpass123', expectedRole: 'SE' },
                { email: 'sales.test@cmrp.com', password: 'testpass123', expectedRole: 'Sales' }
            ];
            
            let results = [];
            
            for (const user of testUsers) {
                try {
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: user.email,
                            password: user.password
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        const payload = JSON.parse(atob(result.token.split('.')[1]));
                        const roles = payload.roles || [];
                        
                        if (roles.includes(user.expectedRole)) {
                            results.push(`‚úÖ ${user.expectedRole} user authentication successful`);
                        } else {
                            results.push(`‚ö†Ô∏è ${user.expectedRole} user authenticated but role mismatch: ${roles.join(', ')}`);
                        }
                    } else {
                        results.push(`‚ùå ${user.expectedRole} user authentication failed`);
                    }
                } catch (error) {
                    results.push(`‚ùå ${user.expectedRole} user authentication error: ${error.message}`);
                }
            }
            
            const passCount = results.filter(r => r.includes('‚úÖ')).length;
            const totalCount = testUsers.length;
            
            resultDiv.innerHTML = `
                <div class="${passCount === totalCount ? 'success' : 'warning'}">
                    <strong>Authentication Test Results (${passCount}/${totalCount} passed):</strong><br>
                    ${results.join('<br>')}
                </div>
            `;
            
            validationResults.push({
                test: 'User Authentication',
                result: passCount === totalCount ? 'PASS' : 'PARTIAL',
                details: results
            });
        }

        // Step 3: Test Filter Mapping
        function testFilterMapping() {
            const resultDiv = document.getElementById('filterMappingResult');
            resultDiv.innerHTML = '<div class="info">Testing role-based filter mapping...</div>';
            
            try {
                // Create test data
                const mockData = [
                    { solutions: 'Data Analytics Platform', account_mgr: 'John Doe' },
                    { solutions: 'Engineering Software Suite', account_mgr: 'Jane Smith' },
                    { solutions: 'Sales Management System', account_mgr: 'Bob Johnson' },
                    { solutions: 'Business Intelligence Dashboard', account_mgr: 'Alice Brown' },
                    { solutions: 'Technical Support Platform', account_mgr: 'Mike Wilson' }
                ];
                
                const testRoles = ['DS', 'SE', 'Sales', 'Admin'];
                let mappingResults = [];
                
                testRoles.forEach(role => {
                    try {
                        const filters = mapUserRolesToFilters([role], mockData);
                        
                        switch (role) {
                            case 'DS':
                                if (filters.solutions && 
                                    (filters.solutions.toLowerCase().includes('data') || 
                                     filters.solutions.toLowerCase().includes('analytics') ||
                                     filters.solutions.toLowerCase().includes('intelligence'))) {
                                    mappingResults.push(`‚úÖ ${role}: Correctly mapped to "${filters.solutions}"`);
                                } else {
                                    mappingResults.push(`‚ùå ${role}: Incorrect or missing mapping`);
                                }
                                break;
                                
                            case 'SE':
                                if (filters.solutions && 
                                    (filters.solutions.toLowerCase().includes('engineering') || 
                                     filters.solutions.toLowerCase().includes('technical'))) {
                                    mappingResults.push(`‚úÖ ${role}: Correctly mapped to "${filters.solutions}"`);
                                } else {
                                    mappingResults.push(`‚ùå ${role}: Incorrect or missing mapping`);
                                }
                                break;
                                
                            case 'Sales':
                            case 'Admin':
                                if (Object.keys(filters).length === 0) {
                                    mappingResults.push(`‚úÖ ${role}: Correctly no filtering applied`);
                                } else {
                                    mappingResults.push(`‚ùå ${role}: Unexpected filtering applied`);
                                }
                                break;
                        }
                    } catch (error) {
                        mappingResults.push(`‚ùå ${role}: Error - ${error.message}`);
                    }
                });
                
                const passCount = mappingResults.filter(r => r.includes('‚úÖ')).length;
                
                resultDiv.innerHTML = `
                    <div class="${passCount === testRoles.length ? 'success' : 'warning'}">
                        <strong>Filter Mapping Test Results (${passCount}/${testRoles.length} passed):</strong><br>
                        ${mappingResults.join('<br>')}
                    </div>
                `;
                
                validationResults.push({
                    test: 'Filter Mapping',
                    result: passCount === testRoles.length ? 'PASS' : 'PARTIAL',
                    details: mappingResults
                });
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Filter mapping test failed: ${error.message}</div>`;
                validationResults.push({
                    test: 'Filter Mapping',
                    result: 'FAIL',
                    error: error.message
                });
            }
        }

        // Step 4: Test Dashboard Auto-Filtering
        async function testDashboardFiltering() {
            const resultDiv = document.getElementById('dashboardFilteringResult');
            resultDiv.innerHTML = '<div class="info">Testing dashboard auto-filtering...</div>';
            
            try {
                // Test if we can call the auto-filter function
                if (typeof applyAutoFiltersForUser === 'function') {
                    // Since we can't fully test without dashboard context, 
                    // we'll verify the function exists and can be called
                    resultDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ Dashboard Auto-Filtering Function Available<br>
                            Function type: ${typeof applyAutoFiltersForUser}<br>
                            Note: Full testing requires dashboard context
                        </div>
                    `;
                    
                    validationResults.push({
                        test: 'Dashboard Auto-Filtering',
                        result: 'PASS',
                        note: 'Function available but requires dashboard context for full testing'
                    });
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            ‚ùå Dashboard Auto-Filtering Function Not Available<br>
                            This indicates the role-based filtering may not be properly implemented
                        </div>
                    `;
                    
                    validationResults.push({
                        test: 'Dashboard Auto-Filtering',
                        result: 'FAIL',
                        error: 'applyAutoFiltersForUser function not available'
                    });
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Dashboard filtering test failed: ${error.message}</div>`;
                validationResults.push({
                    test: 'Dashboard Auto-Filtering',
                    result: 'FAIL',
                    error: error.message
                });
            }
        }

        // Step 5: Test Fallback Mechanism
        function testFallbackMechanism() {
            const resultDiv = document.getElementById('fallbackResult');
            resultDiv.innerHTML = '<div class="info">Testing fallback to username-based filtering...</div>';
            
            try {
                // Test the fallback logic by checking if username-based filtering functions exist
                const hasMapUserNameToFilterValue = typeof mapUserNameToFilterValue === 'function';
                const hasGetCurrentUserName = typeof getCurrentUserName === 'function';
                
                if (hasMapUserNameToFilterValue && hasGetCurrentUserName) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ Fallback Mechanism Available<br>
                            Username mapping function: ${hasMapUserNameToFilterValue ? 'Available' : 'Missing'}<br>
                            Get current user function: ${hasGetCurrentUserName ? 'Available' : 'Missing'}
                        </div>
                    `;
                    
                    validationResults.push({
                        test: 'Fallback Mechanism',
                        result: 'PASS',
                        functions: { mapUserNameToFilterValue: hasMapUserNameToFilterValue, getCurrentUserName: hasGetCurrentUserName }
                    });
                } else {
                    resultDiv.innerHTML = `
                        <div class="warning">
                            ‚ö†Ô∏è Fallback Mechanism Partially Available<br>
                            Username mapping function: ${hasMapUserNameToFilterValue ? 'Available' : 'Missing'}<br>
                            Get current user function: ${hasGetCurrentUserName ? 'Available' : 'Missing'}
                        </div>
                    `;
                    
                    validationResults.push({
                        test: 'Fallback Mechanism',
                        result: 'PARTIAL',
                        functions: { mapUserNameToFilterValue: hasMapUserNameToFilterValue, getCurrentUserName: hasGetCurrentUserName }
                    });
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Fallback mechanism test failed: ${error.message}</div>`;
                validationResults.push({
                    test: 'Fallback Mechanism',
                    result: 'FAIL',
                    error: error.message
                });
            }
        }

        // Complete Validation
        async function runCompleteValidation() {
            const reportDiv = document.getElementById('validationReport');
            reportDiv.innerHTML = '<div class="info">Running complete validation...</div>';
            
            // Clear previous results
            validationResults = [];
            
            // Run all validation steps
            await checkSystemStatus();
            await validateRoleSystem();
            await testUserAuthentication();
            testFilterMapping();
            await testDashboardFiltering();
            testFallbackMechanism();
            
            // Generate summary
            const totalTests = validationResults.length;
            const passedTests = validationResults.filter(r => r.result === 'PASS').length;
            const partialTests = validationResults.filter(r => r.result === 'PARTIAL').length;
            const failedTests = validationResults.filter(r => r.result === 'FAIL').length;
            const errorTests = validationResults.filter(r => r.result === 'ERROR').length;
            
            const overallStatus = passedTests === totalTests ? 'COMPLETE SUCCESS' :
                                passedTests + partialTests === totalTests ? 'PARTIAL SUCCESS' :
                                'NEEDS ATTENTION';
            
            reportDiv.innerHTML = `
                <div class="${overallStatus === 'COMPLETE SUCCESS' ? 'success' : overallStatus === 'PARTIAL SUCCESS' ? 'warning' : 'error'}">
                    <h3>üéØ Complete Validation Report</h3>
                    <p><strong>Overall Status:</strong> ${overallStatus}</p>
                    <p><strong>Total Tests:</strong> ${totalTests}</p>
                    <p><strong>Passed:</strong> ${passedTests}</p>
                    <p><strong>Partial:</strong> ${partialTests}</p>
                    <p><strong>Failed:</strong> ${failedTests}</p>
                    <p><strong>Errors:</strong> ${errorTests}</p>
                    
                    <h4>Test Results Summary:</h4>
                    <ul>
                        ${validationResults.map(r => 
                            `<li><strong>${r.test}:</strong> ${r.result}${r.error ? ` (${r.error})` : ''}</li>`
                        ).join('')}
                    </ul>
                </div>
            `;
        }

        function downloadValidationReport() {
            if (validationResults.length === 0) {
                alert('Please run validation first');
                return;
            }
            
            const report = {
                timestamp: new Date().toISOString(),
                summary: {
                    total: validationResults.length,
                    passed: validationResults.filter(r => r.result === 'PASS').length,
                    partial: validationResults.filter(r => r.result === 'PARTIAL').length,
                    failed: validationResults.filter(r => r.result === 'FAIL').length,
                    errors: validationResults.filter(r => r.result === 'ERROR').length
                },
                results: validationResults
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `role-filtering-validation-report-${new Date().toISOString().slice(0, 19)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Live Testing
        function simulateRoleFiltering() {
            const role = document.getElementById('testRole').value;
            const resultDiv = document.getElementById('liveTestResult');
            
            if (!testData) {
                resultDiv.innerHTML = '<div class="warning">‚ö†Ô∏è Please load test data first</div>';
                return;
            }
            
            try {
                const filters = mapUserRolesToFilters([role], testData);
                
                resultDiv.innerHTML = `
                    <div class="info">
                        <h4>Role Filtering Simulation: ${role}</h4>
                        <p><strong>Applied Filters:</strong> ${Object.keys(filters).length > 0 ? JSON.stringify(filters) : 'None (as expected for Sales/Admin)'}</p>
                        <pre>${JSON.stringify(filters, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Simulation failed: ${error.message}</div>`;
            }
        }

        function loadTestData() {
            testData = [
                { solutions: 'Data Analytics Platform', account_mgr: 'John Doe', pic: 'Jane Smith' },
                { solutions: 'Engineering Software Suite', account_mgr: 'Bob Johnson', pic: 'Alice Brown' },
                { solutions: 'Sales CRM System', account_mgr: 'Mike Wilson', pic: 'Sarah Davis' },
                { solutions: 'Business Intelligence Dashboard', account_mgr: 'Tom Anderson', pic: 'Lisa Garcia' },
                { solutions: 'Technical Support Platform', account_mgr: 'Chris Lee', pic: 'Maria Rodriguez' }
            ];
            
            document.getElementById('liveTestResult').innerHTML = `
                <div class="success">
                    ‚úÖ Test data loaded successfully<br>
                    <strong>Loaded ${testData.length} test opportunities</strong>
                </div>
            `;
        }

        function validateFilterLogic() {
            const resultDiv = document.getElementById('liveTestResult');
            
            if (!testData) {
                resultDiv.innerHTML = '<div class="warning">‚ö†Ô∏è Please load test data first</div>';
                return;
            }
            
            const roles = ['DS', 'SE', 'Sales', 'Admin'];
            let results = [];
            
            roles.forEach(role => {
                const filters = mapUserRolesToFilters([role], testData);
                results.push(`<strong>${role}:</strong> ${Object.keys(filters).length > 0 ? JSON.stringify(filters) : 'No filtering'}`);
            });
            
            resultDiv.innerHTML = `
                <div class="info">
                    <h4>Filter Logic Validation Results</h4>
                    ${results.join('<br>')}
                </div>
            `;
        }

        // Role filtering function for testing
        function mapUserRolesToFilters(userRoles, availableData) {
            const filters = {};
            
            if (!userRoles || userRoles.length === 0 || !availableData) {
                return filters;
            }
            
            const solutions = Array.from(new Set(availableData.map(item => item.solutions).filter(Boolean)));
            
            userRoles.forEach(role => {
                switch(role.toUpperCase()) {
                    case 'DS':
                        const dsFilters = solutions.filter(sol => 
                            sol.toLowerCase().includes('data') || 
                            sol.toLowerCase().includes('analytics') ||
                            sol.toLowerCase().includes('intelligence') ||
                            sol.toLowerCase().includes('ds')
                        );
                        if (dsFilters.length > 0) {
                            filters.solutions = dsFilters[0];
                        }
                        break;
                        
                    case 'SE':
                        const seFilters = solutions.filter(sol => 
                            sol.toLowerCase().includes('engineering') || 
                            sol.toLowerCase().includes('technical') ||
                            sol.toLowerCase().includes('se')
                        );
                        if (seFilters.length > 0) {
                            filters.solutions = seFilters[0];
                        }
                        break;
                        
                    case 'SALES':
                    case 'ADMIN':
                        // No automatic filtering
                        break;
                }
            });
            
            return filters;
        }

        // Initialize page
        console.log('Role-Based Filtering End-to-End Validation initialized');
        console.log('Follow the step-by-step validation process or run complete validation');
    </script>
</body>
</html>
