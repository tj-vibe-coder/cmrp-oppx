<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management API Debug</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .debug-container {
            margin: 20px;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .debug-section {
            margin: 15px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 3px;
        }
        .json-output {
            background: #222;
            color: #0f0;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .test-button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #005a87;
        }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>User Management API Debug</h1>
        
        <div class="debug-section">
            <h2>Authentication Status</h2>
            <div id="auth-status">Checking...</div>
            <button class="test-button" onclick="testAuth()">Test Authentication</button>
        </div>

        <div class="debug-section">
            <h2>API Response Test</h2>
            <button class="test-button" onclick="testUsersAPI()">Test /api/users Endpoint</button>
            <button class="test-button" onclick="testUsersAPIRaw()">Test Raw Response</button>
            <div id="api-response" class="json-output">Click button to test API...</div>
        </div>

        <div class="debug-section">
            <h2>Frontend Table Rendering Test</h2>
            <button class="test-button" onclick="testTableRendering()">Test Table Rendering</button>
            <div id="table-test">
                <table id="debug-table" style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <thead>
                        <tr style="background: #f0f0f0;">
                            <th style="border: 1px solid #ccc; padding: 8px;">Username</th>
                            <th style="border: 1px solid #ccc; padding: 8px;">Email</th>
                            <th style="border: 1px solid #ccc; padding: 8px;">Roles</th>
                            <th style="border: 1px solid #ccc; padding: 8px;">Account Type</th>
                            <th style="border: 1px solid #ccc; padding: 8px;">Verified</th>
                        </tr>
                    </thead>
                    <tbody id="debug-table-body">
                        <tr><td colspan="5" style="text-align: center; padding: 20px;">No data loaded yet</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="debug-section">
            <h2>Database Fields Analysis</h2>
            <div id="field-analysis" class="json-output">Click test buttons above to see field analysis...</div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // API Configuration
        function getApiUrl(endpoint) {
            if (typeof window !== 'undefined' && window.APP_CONFIG) {
                return window.APP_CONFIG.API_BASE_URL + endpoint;
            }
            return (window.location.hostname === 'localhost' ? 'http://localhost:3000' : 'https://cmrp-opps-backend.onrender.com') + endpoint;
        }

        function log(message, elementId, isError = false) {
            const element = document.getElementById(elementId);
            if (element) {
                const timestamp = new Date().toLocaleTimeString();
                const className = isError ? 'error' : 'success';
                element.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            }
            console.log(`[DEBUG] ${message}`);
        }

        async function testAuth() {
            const token = localStorage.getItem('authToken');
            const statusDiv = document.getElementById('auth-status');
            
            if (!token) {
                statusDiv.innerHTML = '<span class="error">❌ No auth token found</span>';
                return false;
            }

            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                statusDiv.innerHTML = `
                    <div class="success">✅ Token found</div>
                    <div>User: ${payload.email || 'Unknown'}</div>
                    <div>Account Type: ${payload.accountType || payload.account_type || 'Unknown'}</div>
                    <div>Roles: ${JSON.stringify(payload.roles || [])}</div>
                    <div>User ID: ${payload.id || 'Unknown'}</div>
                `;
                return true;
            } catch (error) {
                statusDiv.innerHTML = `<span class="error">❌ Invalid token: ${error.message}</span>`;
                return false;
            }
        }

        async function testUsersAPI() {
            const responseDiv = document.getElementById('api-response');
            responseDiv.textContent = 'Testing API...';

            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    responseDiv.textContent = 'ERROR: No auth token found';
                    return;
                }

                const response = await fetch(getApiUrl('/api/users'), {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const responseText = await response.text();
                let parsedData;

                try {
                    parsedData = JSON.parse(responseText);
                } catch (parseError) {
                    responseDiv.textContent = `PARSE ERROR: ${parseError.message}\n\nRaw Response:\n${responseText}`;
                    return;
                }

                if (!response.ok) {
                    responseDiv.textContent = `API ERROR (${response.status}): ${JSON.stringify(parsedData, null, 2)}`;
                    return;
                }

                // Success - analyze the data structure
                responseDiv.textContent = JSON.stringify(parsedData, null, 2);
                
                // Analyze fields
                analyzeFields(parsedData);

            } catch (error) {
                responseDiv.textContent = `FETCH ERROR: ${error.message}`;
            }
        }

        async function testUsersAPIRaw() {
            const responseDiv = document.getElementById('api-response');
            responseDiv.textContent = 'Testing raw API response...';

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(getApiUrl('/api/users'), {
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                });

                const headers = {};
                response.headers.forEach((value, key) => {
                    headers[key] = value;
                });

                const responseText = await response.text();
                
                const rawAnalysis = {
                    status: response.status,
                    statusText: response.statusText,
                    headers: headers,
                    bodyLength: responseText.length,
                    bodyPreview: responseText.substring(0, 500),
                    fullBody: responseText
                };

                responseDiv.textContent = JSON.stringify(rawAnalysis, null, 2);
            } catch (error) {
                responseDiv.textContent = `RAW TEST ERROR: ${error.message}`;
            }
        }

        function analyzeFields(data) {
            const analysisDiv = document.getElementById('field-analysis');
            
            if (!Array.isArray(data) || data.length === 0) {
                analysisDiv.textContent = 'No user data to analyze';
                return;
            }

            const sampleUser = data[0];
            const fieldAnalysis = {
                totalUsers: data.length,
                sampleUserFields: Object.keys(sampleUser),
                fieldTypes: {},
                expectedFields: ['_id', 'username', 'email', 'role', 'accountType'],
                missingFields: [],
                extraFields: []
            };

            // Analyze field types
            Object.keys(sampleUser).forEach(key => {
                const value = sampleUser[key];
                fieldAnalysis.fieldTypes[key] = {
                    type: typeof value,
                    isArray: Array.isArray(value),
                    value: value
                };
            });

            // Check for missing expected fields
            fieldAnalysis.expectedFields.forEach(field => {
                if (!sampleUser.hasOwnProperty(field)) {
                    fieldAnalysis.missingFields.push(field);
                }
            });

            // Check for extra fields
            Object.keys(sampleUser).forEach(field => {
                if (!fieldAnalysis.expectedFields.includes(field)) {
                    fieldAnalysis.extraFields.push(field);
                }
            });

            analysisDiv.textContent = JSON.stringify(fieldAnalysis, null, 2);
        }

        async function testTableRendering() {
            const tbody = document.getElementById('debug-table-body');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">Loading...</td></tr>';

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(getApiUrl('/api/users'), {
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const users = await response.json();
                tbody.innerHTML = '';

                if (!users || users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">No users found</td></tr>';
                    return;
                }

                users.forEach(user => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td style="border: 1px solid #ccc; padding: 8px;">${user.username || user.name || 'N/A'}</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">${user.email || 'N/A'}</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">${Array.isArray(user.role) ? user.role.join(', ') : (Array.isArray(user.roles) ? user.roles.join(', ') : (user.role || user.roles || 'N/A'))}</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">${user.accountType || user.account_type || 'N/A'}</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">${user.is_verified ? '✅' : '❌'}</td>
                    `;
                });

            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 20px; color: red;">Error: ${error.message}</td></tr>`;
            }
        }

        // Auto-run auth test on page load
        window.addEventListener('load', () => {
            testAuth();
        });
    </script>
</body>
</html>
